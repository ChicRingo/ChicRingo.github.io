<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://ChicRingo.github.io</id>
    <title>ChicRingoä¸ªäººåšå®¢</title>
    <updated>2020-10-11T07:28:57.739Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://ChicRingo.github.io"/>
    <link rel="self" href="https://ChicRingo.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://ChicRingo.github.io/images/avatar.png</logo>
    <icon>https://ChicRingo.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, ChicRingoä¸ªäººåšå®¢</rights>
    <entry>
        <title type="html"><![CDATA[Go æ¯æ—¥ä¸€åº“ä¹‹ jobrunner]]></title>
        <id>https://ChicRingo.github.io/post/go-mei-ri-yi-ku-zhi-jobrunner/</id>
        <link href="https://ChicRingo.github.io/post/go-mei-ri-yi-ku-zhi-jobrunner/">
        </link>
        <updated>2020-09-03T02:22:12.000Z</updated>
        <summary type="html"><![CDATA[<ol>
<li>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>æˆ‘ä»¬åœ¨ Web å¼€å‘ä¸­æ—¶å¸¸ä¼šé‡åˆ°è¿™æ ·çš„éœ€æ±‚ï¼Œæ‰§è¡Œä¸€ä¸ªæ“ä½œä¹‹åï¼Œéœ€è¦ç»™ç”¨æˆ·ä¸€å®šå½¢å¼çš„é€šçŸ¥ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·ä¸‹å•ä¹‹åé€šè¿‡é‚®ä»¶å‘é€ç”µå­å‘ç¥¨ï¼Œç½‘ä¸Šè´­ç¥¨æ”¯ä»˜åé€šè¿‡çŸ­ä¿¡å‘é€è½¦æ¬¡ä¿¡æ¯ã€‚ä½†æ˜¯è¿™ç±»éœ€æ±‚å¹¶ä¸éœ€è¦éå¸¸åŠæ—¶ï¼Œå¦‚æœæ”¾åœ¨è¯·æ±‚æµç¨‹ä¸­å¤„ç†ï¼Œä¼šå½±å“è¯·æ±‚çš„å“åº”æ—¶é—´ã€‚è¿™ç±»ä»»åŠ¡æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼æ¥æ‰§è¡Œã€‚<code>jobrunner</code>å°±æ˜¯å…¶ä¸­ä¸€ä¸ªç”¨æ¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„ Go è¯­è¨€åº“ã€‚å¾—ç›Šäºå¼ºå¤§çš„<code>cron</code>åº“ï¼Œå†æ­é…<code>jobrunner</code>çš„ä»»åŠ¡çŠ¶æ€ç›‘æ§ï¼Œ<code>jobrunner</code>éå¸¸æ˜“äºä½¿ç”¨ã€‚</p>
</li>
</ol>
]]></summary>
        <content type="html"><![CDATA[<ol>
<li>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<p>æˆ‘ä»¬åœ¨ Web å¼€å‘ä¸­æ—¶å¸¸ä¼šé‡åˆ°è¿™æ ·çš„éœ€æ±‚ï¼Œæ‰§è¡Œä¸€ä¸ªæ“ä½œä¹‹åï¼Œéœ€è¦ç»™ç”¨æˆ·ä¸€å®šå½¢å¼çš„é€šçŸ¥ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·ä¸‹å•ä¹‹åé€šè¿‡é‚®ä»¶å‘é€ç”µå­å‘ç¥¨ï¼Œç½‘ä¸Šè´­ç¥¨æ”¯ä»˜åé€šè¿‡çŸ­ä¿¡å‘é€è½¦æ¬¡ä¿¡æ¯ã€‚ä½†æ˜¯è¿™ç±»éœ€æ±‚å¹¶ä¸éœ€è¦éå¸¸åŠæ—¶ï¼Œå¦‚æœæ”¾åœ¨è¯·æ±‚æµç¨‹ä¸­å¤„ç†ï¼Œä¼šå½±å“è¯·æ±‚çš„å“åº”æ—¶é—´ã€‚è¿™ç±»ä»»åŠ¡æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨å¼‚æ­¥çš„æ–¹å¼æ¥æ‰§è¡Œã€‚<code>jobrunner</code>å°±æ˜¯å…¶ä¸­ä¸€ä¸ªç”¨æ¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„ Go è¯­è¨€åº“ã€‚å¾—ç›Šäºå¼ºå¤§çš„<code>cron</code>åº“ï¼Œå†æ­é…<code>jobrunner</code>çš„ä»»åŠ¡çŠ¶æ€ç›‘æ§ï¼Œ<code>jobrunner</code>éå¸¸æ˜“äºä½¿ç”¨ã€‚</p>
</li>
</ol>
<!-- more -->
<h2 id="å¿«é€Ÿä½¿ç”¨">å¿«é€Ÿä½¿ç”¨</h2>
<p>æœ¬æ–‡ä½¿ç”¨ Go Modulesã€‚</p>
<p>åˆ›å»ºç›®å½•å¹¶åˆå§‹åŒ–ï¼š</p>
<pre><code>$ mkdir jobrunner &amp;&amp; cd jobrunner
$ go mod init github.com/darjun/go-daily-lib/jobrunner
</code></pre>
<p>å®‰è£…<code>jobrunner</code>ï¼š</p>
<pre><code>$ go get -u github.com/bamzi/jobrunner
</code></pre>
<p>ä½¿ç”¨ï¼š</p>
<pre><code>package main

import (
  &quot;fmt&quot;
  &quot;time&quot;

  &quot;github.com/bamzi/jobrunner&quot;
)

type GreetingJob struct {
  Name string
}

func (g GreetingJob) Run() {
  fmt.Println(&quot;Hello, &quot;, g.Name)
}

func main() {
  jobrunner.Start()
  jobrunner.Schedule(&quot;@every 5s&quot;, GreetingJob{Name: &quot;dj&quot;})

  time.Sleep(10 * time.Second)
}
</code></pre>
<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œæ¯éš” 5s æ‰“å°ä¸€æ¡æ¬¢è¿ä¿¡æ¯ã€‚ä»»åŠ¡çš„åˆ›å»ºå’Œæ‰§è¡Œä¸<code>cron</code>å®Œå…¨ç›¸åŒï¼Œè¯¦ç»†ä½¿ç”¨è§æˆ‘å‰é¢çš„ä¸€ç¯‡åšæ–‡ã€‚</p>
<p>æ³¨æ„ï¼Œ<code>jobrunner</code>éœ€è¦å…ˆ<code>Start()</code>ï¼Œç„¶åå†æ·»åŠ ä»»åŠ¡ã€‚å› ä¸ºåœ¨<code>Start()</code>ä¸­åˆ›å»º<code>MainCron</code>å¯¹è±¡ï¼Œå…ˆæ·»åŠ ä»»åŠ¡ä¼š<code>panic</code>ï¼ï¼ï¼</p>
<p>æ³¨æ„<code>main</code>å‡½æ•°å°¾çš„<code>time.Sleep(10 * time.Second)</code>ï¼Œå› ä¸ºä¸» goroutine ç»“æŸä¹‹åæ•´ä¸ªç¨‹åºå°±é€€å‡ºäº†ï¼Œ<code>jobrunner</code>ä¸­çš„ä»»åŠ¡å°±æ²¡æœ‰æœºä¼šè¢«æ‰§è¡Œäº†ã€‚åŠ ä¸Š<code>time.Sleep</code>æ˜¯ä¸ºäº†è®©å¤§å®¶èƒ½çœ‹åˆ°è¾“å‡ºï¼Œå®é™…ä½¿ç”¨ä¸­ä¸ä¼šè¿™æ ·åšã€‚</p>
<h2 id="ä¸-web-æ¡†æ¶æ•´åˆ">ä¸ web æ¡†æ¶æ•´åˆ</h2>
<p><code>jobrunner</code>èƒ½å¾ˆæ–¹ä¾¿åœ°ä¸å½“å‰å¸¸è§çš„ Web æ¡†æ¶æ•´åˆï¼Œå¦‚<code>Gin/Echo/Martini/Beego/Revel</code>ç­‰ã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¼”ç¤ºå¦‚ä½•åœ¨ Gin ä¸­ä½¿ç”¨<code>jobrunner</code>ï¼šç”¨æˆ·ç™»å½•æ—¶ç»™ä»–çš„é‚®ç®±å‘é€ä¸€å°é‚®ä»¶ã€‚</p>
<p>é¦–å…ˆéœ€è¦å®‰è£…ç›¸åº”çš„åº“ï¼š</p>
<pre><code>$ go get -u github.com/gin-gonic/gin
$ github.com/jordan-wright/email
</code></pre>
<p>ç¼–å†™ä»£ç ï¼š</p>
<pre><code>package main

import (
  &quot;fmt&quot;
  &quot;net/smtp&quot;
  &quot;time&quot;

  &quot;github.com/bamzi/jobrunner&quot;
  &quot;github.com/gin-gonic/gin&quot;
  &quot;github.com/jordan-wright/email&quot;
)

type EmailJob struct {
  Name  string
  Email string
}

type User struct {
  Name  string `form:&quot;name&quot;`
  Email string `form:&quot;email&quot;`
}

func (j EmailJob) Run() {
  e := email.NewEmail()
  e.From = &quot;leedarjun@126.com&quot;
  e.To = []string{j.Email}
  e.Cc = []string{&quot;leedarjun@126.com&quot;}
  e.Subject = &quot;Welcome To Awesome-Web&quot;
  e.Text = []byte(fmt.Sprintf(`
  Hello, %s
  Welcome Back
  `, j.Name))

  err := e.Send(&quot;smtp.126.com:25&quot;, smtp.PlainAuth(&quot;&quot;, &quot;leedarjun@126.com&quot;, &quot;yyyyyy&quot;, &quot;smtp.126.com&quot;))
  if err != nil {
    fmt.Printf(&quot;failed to send email to %s, err:%v&quot;, j.Name, err)
  }
}

func login(c *gin.Context) {
  var u User
  if c.ShouldBind(&amp;u) == nil {
    c.String(200, &quot;login success&quot;)

    jobrunner.In(5*time.Second, EmailJob{Name: u.Name, Email: u.Email})
  } else {
    c.String(404, &quot;login failed&quot;)
  }
}

func main() {
  r := gin.Default()
  r.GET(&quot;/login&quot;, login)
  r.Run(&quot;:8888&quot;)
}
</code></pre>
<p>è¿™é‡Œåªæ˜¯ä¸ºäº†ç®€å•æ¼”ç¤ºï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªç®€é™‹çš„<code>login</code>å‡½æ•°å¤„ç†ç™»å½•ï¼Œä¼ å…¥<code>name</code>å’Œ<code>email</code>ï¼Œç„¶åç»™è¯¥<code>email</code>å‘é€é‚®ä»¶ã€‚<code>email</code>åº“çš„è¯¦ç»†ä½¿ç”¨å¯ä»¥æŸ¥çœ‹æˆ‘ä¹‹å‰çš„åšæ–‡äº†è§£ã€‚</p>
<p>åªéœ€è¦åœ¨æµè§ˆå™¨ä¸­è¾“å…¥<code>http://localhost:8888/login?name=dj&amp;email=935653229@qq.com</code>ï¼Œæˆ‘çš„ QQ é‚®ç®±å°±èƒ½æ”¶åˆ°é‚®ä»¶ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://mmbiz.qpic.cn/mmbiz_png/K8wfjf2LnNWiacxBicZx9GWLrWL3QCD5EFdk46hmzrPKRUwViakiad7HsW5wC2zVngb2rn0McfhNhoEG9q3lMyjmtQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img" loading="lazy"></figure>
<h2 id="ç›‘æ§">ç›‘æ§</h2>
<p><code>jobrunner</code>å†…ç½®äº†ä¸€ä¸ªç›‘æ§æ¨¡å—ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°é€šè¿‡ç½‘é¡µæˆ–è€… API è·å–å½“å‰çš„ä»»åŠ¡çŠ¶æ€æ•°æ®ï¼š</p>
<pre><code>package main

import (
  &quot;fmt&quot;
  &quot;html/template&quot;
  &quot;os&quot;
  &quot;time&quot;

  &quot;github.com/bamzi/jobrunner&quot;
  &quot;github.com/gin-gonic/gin&quot;
)

type GreetingJob struct {
  Name string
}

func (g GreetingJob) Run() {
  fmt.Println(&quot;Hello,&quot;, g.Name)
}

type EmailJob struct {
  Email string
}

func (e EmailJob) Run() {
  fmt.Println(&quot;Send,&quot;, e.Email)
}

func main() {
  r := gin.Default()

  jobrunner.Start()
  jobrunner.Every(5*time.Second, GreetingJob{Name: &quot;dj&quot;})
  jobrunner.Every(10*time.Second, EmailJob{Email: &quot;935653229@qq.com&quot;})

  r.GET(&quot;/jobrunner/json&quot;, JobJson)
  r.GET(&quot;/jobrunner/html&quot;, JobHtml)

  r.Run(&quot;:8888&quot;)
}

func JobJson(c *gin.Context) {
  c.JSON(200, jobrunner.StatusJson())
}

func JobHtml(c *gin.Context) {
  t, err := template.ParseFiles(os.Getenv(&quot;GOPATH&quot;) + &quot;/src/github.com/bamzi/jobrunner/views/Status.html&quot;)
  if err != nil {
    c.JSON(400, &quot;error&quot;)
  }
  t.Execute(c.Writer, jobrunner.StatusPage())
}
</code></pre>
<p>è¿è¡Œä¹‹åï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥<code>http://localhost:8888/jobrunner/html</code>æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€ï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://mmbiz.qpic.cn/mmbiz_png/K8wfjf2LnNWiacxBicZx9GWLrWL3QCD5EF2KYuh16uQkoqLkHok2cIH6oACuXYvLThnPaInUu2gicpg7N4a7A01pg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img" loading="lazy"></figure>
<p>è¿™é‡Œæ˜¾ç¤ºä»»åŠ¡åã€ä»»åŠ¡ IDã€çŠ¶æ€ã€ä¸Šæ¬¡è¿è¡Œæ—¶é—´ã€ä¸‹æ¬¡è¿è¡Œæ—¶é—´ä»¥åŠå¤„ç†å»¶è¿Ÿã€‚</p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡<code>http://localhost:8888/jobrunner/json</code>è·å–åŸå§‹ JSON æ ¼å¼çš„æ•°æ®è‡ªå·±å¤„ç†ï¼š</p>
<figure data-type="image" tabindex="3"><img src="https://mmbiz.qpic.cn/mmbiz_png/K8wfjf2LnNWiacxBicZx9GWLrWL3QCD5EFMdLTUsC2a5kibeIj35PZOvmuVUMOhTpBow83yTBh7jdEUeRQsAiaQCxg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img" loading="lazy"></figure>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>å¤§å®¶å¦‚æœå‘ç°å¥½ç©ã€å¥½ç”¨çš„ Go è¯­è¨€åº“ï¼Œæ¬¢è¿åˆ° Go æ¯æ—¥ä¸€åº“ GitHub ä¸Šæäº¤ issueğŸ˜„</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ol>
<li>jobrunner GitHubï¼šhttps://github.com/bamzi/jobrunner</li>
<li>Go æ¯æ—¥ä¸€åº“ GitHubï¼šhttps://github.com/darjun/go-daily-lib</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åˆ©ç”¨Goåå°„æœºåˆ¶å®ç°åˆ¤æ–­sliceä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªitem]]></title>
        <id>https://ChicRingo.github.io/post/li-yong-go-fan-she-ji-zhi-shi-xian-pan-duan-slice-zhong-shi-fou-cun-zai-mou-ge-item/</id>
        <link href="https://ChicRingo.github.io/post/li-yong-go-fan-she-ji-zhi-shi-xian-pan-duan-slice-zhong-shi-fou-cun-zai-mou-ge-item/">
        </link>
        <updated>2020-08-31T01:00:43.000Z</updated>
        <summary type="html"><![CDATA[<h2 id="ä¸ºä»€ä¹ˆéœ€è¦">ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ</h2>
<p>æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ç»å¸¸é‡åˆ°éœ€è¦åˆ¤æ–­æŸä¸ª slice(æˆ–è€… array)ä¸­æ˜¯å¦åŒ…å«æŸä¸ª item çš„æƒ…å†µï¼Œæ¯”å¦‚åˆ¤æ–­ 10 æ˜¯å¦åœ¨[]int{1,2,3}ä¸­</p>
]]></summary>
        <content type="html"><![CDATA[<h2 id="ä¸ºä»€ä¹ˆéœ€è¦">ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ</h2>
<p>æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ç»å¸¸é‡åˆ°éœ€è¦åˆ¤æ–­æŸä¸ª slice(æˆ–è€… array)ä¸­æ˜¯å¦åŒ…å«æŸä¸ª item çš„æƒ…å†µï¼Œæ¯”å¦‚åˆ¤æ–­ 10 æ˜¯å¦åœ¨[]int{1,2,3}ä¸­</p>
<!-- more -->
<h2 id="æ€ä¹ˆåš">æ€ä¹ˆåšï¼Ÿ</h2>
<p>ä¸€èˆ¬æœ€å®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•æ˜¯éå† slice ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œç›´åˆ°æ‰¾åˆ°äº†è¯¥å…ƒç´ ï¼Œå¦åˆ™è¿”å› falseï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package main

func IsInSlice(value int, sli []int) bool {
    for _, v := range sli {
     if value == v {
      return true
     }
    }
    return false
}
</code></pre>
<p>è¿™ç§æ–¹æ³•å®ç°ç•¥æ˜¾ç¬¨æ‹™ï¼Œå¹¶ä¸”é’ˆå¯¹ä¸åŒçš„æ•°æ®ç±»å‹æ— æ³•é€šç”¨ï¼Œå¦‚æœæœ‰ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œåˆ™å®¹æ˜“ç”Ÿæˆå¾ˆå¤šç›¸åŒåŠŸèƒ½çš„å‡½æ•°ï¼Œåªæ˜¯å‚æ•°ä¸åŒï¼Œè¿™æ ·çš„è¯ä»£ç å¯ç”¨æ€§å¹¶ä¸é«˜ã€‚</p>
<h2 id="å¦‚ä½•æ”¹è¿›">å¦‚ä½•æ”¹è¿›</h2>
<p>golang ä¸­å¯ä»¥é€šè¿‡ reflect åŒ…ä¸­çš„ TypeOf(), ValueOf()å’Œ DeepEqual()æ¥å£å¯¹æ–¹æ³•è¿›è¡Œæ”¹è¿›ï¼Œæ–¹æ³•å‚æ•°ä½¿ç”¨ interface{}ç±»å‹ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package main

import &quot;reflect&quot;

func IsInSlice(value interface{}, sli interface{}) bool {
    switch reflect.TypeOf(sli).Kind() {
    case reflect.Slice, reflect.Array:
     s := reflect.ValueOf(sli)
     for i := 0; i &lt; s.Len(); i++ {
      if reflect.DeepEqual(value, s.Index(i).Interface()) {
       return true
      }
     }
    }
    return false
}
</code></pre>
<p>ç¬é—´ä¸ç”¨å†ä¸ºä¸åŒæ•°æ®ç±»å‹éœ€è¦å†™ä¸åŒå‡½æ•°è€Œå¿ƒçƒ¦äº†ï¼</p>
<h2 id="æç¤º">æç¤º</h2>
<p>å› ä¸ºåå°„éœ€è¦çš„æ—¶é—´å¼€é”€æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥é€šç”¨å†™æ³•çš„æ•ˆç‡è‚¯å®šæ¯”ç‰¹å®šç±»å‹çš„å†™æ³•ä½ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®å®é™…æƒ…å†µæ¥æƒè¡¡ä½¿ç”¨ï¼Œå¦‚ä¸‹æˆªå›¾ä¸º int ç±»å‹çš„åŸºå‡†æµ‹è¯•ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://pyihe.github.io/assets/img/2020-05-29/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95.jpg" alt="img" loading="lazy"></figure>
<blockquote>
<p>åŸæ–‡ä½œè€…ï¼špyihe</p>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://pyihe.github.io/2020/05/29/Golang%E5%88%A4%E6%96%ADslice%E4%B8%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%9F%90%E4%B8%AAitem.html</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä½¿ç”¨Goå®ç°GoFçš„23ç§è®¾è®¡æ¨¡å¼ï¼ˆäºŒï¼‰]]></title>
        <id>https://ChicRingo.github.io/post/shi-yong-go-shi-xian-gof-de-23-chong-she-ji-mo-shi-er/</id>
        <link href="https://ChicRingo.github.io/post/shi-yong-go-shi-xian-gof-de-23-chong-she-ji-mo-shi-er/">
        </link>
        <updated>2020-08-28T15:15:08.000Z</updated>
        <summary type="html"><![CDATA[<p>ä½œè€…ï¼šå…ƒé—°å­<br>
é“¾æ¥ï¼šhttps://juejin.im/post/6864011017384132621<br>
æ¥æºï¼šæ˜é‡‘<br>
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>ä½œè€…ï¼šå…ƒé—°å­<br>
é“¾æ¥ï¼šhttps://juejin.im/post/6864011017384132621<br>
æ¥æºï¼šæ˜é‡‘<br>
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
<!-- more -->
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>ä¸Šä¸€ç¯‡æ–‡ç« <a href="https://juejin.im/post/6859015515344633863">ã€Šä½¿ç”¨Goå®ç°GoFçš„23ç§è®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰ã€‹</a>ä»‹ç»äº†23ç§è®¾è®¡æ¨¡å¼ä¸­çš„<strong>åˆ›å»ºå‹æ¨¡å¼</strong>ï¼ˆCreational Patternï¼‰ï¼Œåˆ›å»ºå‹æ¨¡å¼æ˜¯å¤„ç†å¯¹è±¡åˆ›å»ºçš„ä¸€ç±»è®¾è®¡æ¨¡å¼ï¼Œä¸»è¦æ€æƒ³æ˜¯<strong>å‘å¯¹è±¡çš„ä½¿ç”¨è€…éšè—å¯¹è±¡åˆ›å»ºçš„å…·ä½“ç»†èŠ‚</strong>ï¼Œä»è€Œè¾¾åˆ°è§£è€¦çš„ç›®çš„ã€‚æœ¬æ–‡ä¸»è¦èšç„¦åœ¨<strong>ç»“æ„å‹æ¨¡å¼</strong>ï¼ˆStructural Patternï¼‰ä¸Šï¼Œå…¶ä¸»è¦æ€æƒ³æ˜¯<strong>å°†å¤šä¸ªå¯¹è±¡ç»„è£…æˆè¾ƒå¤§çš„ç»“æ„ï¼Œå¹¶åŒæ—¶ä¿æŒç»“æ„çš„çµæ´»å’Œé«˜æ•ˆ</strong>ï¼Œä»ç¨‹åºçš„ç»“æ„ä¸Šè§£å†³æ¨¡å—ä¹‹é—´çš„è€¦åˆé—®é¢˜ã€‚</p>
<h2 id="ç»„åˆæ¨¡å¼composite-pattern">ç»„åˆæ¨¡å¼ï¼ˆComposite Patternï¼‰</h2>
<figure data-type="image" tabindex="1"><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghvdqutjd5j312k0iue81.jpg" alt="ç»„åˆæ¨¡å¼ç»“æ„" loading="lazy"></figure>
<h3 id="ç®€è¿°">ç®€è¿°</h3>
<p>åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªå¸¸è§çš„å¯¹è±¡è®¾è®¡æ–¹æ³•ï¼Œ<strong>ç»„åˆ</strong>å’Œ<strong>ç»§æ‰¿</strong>ï¼Œä¸¤è€…éƒ½å¯ä»¥è§£å†³ä»£ç å¤ç”¨çš„é—®é¢˜ï¼Œä½†æ˜¯ä½¿ç”¨åè€…æ—¶å®¹æ˜“å‡ºç°ç»§æ‰¿å±‚æ¬¡è¿‡æ·±ï¼Œå¯¹è±¡å…³ç³»è¿‡äºå¤æ‚çš„å‰¯ä½œç”¨ï¼Œä»è€Œå¯¼è‡´ä»£ç çš„å¯ç»´æŠ¤æ€§å˜å·®ã€‚å› æ­¤ï¼Œä¸€ä¸ªç»å…¸çš„é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™æ˜¯ï¼š<strong>ç»„åˆä¼˜äºç»§æ‰¿</strong>ã€‚</p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œç»„åˆæ‰€è¡¨ç¤ºçš„è¯­ä¹‰ä¸ºâ€œhas-aâ€ï¼Œä¹Ÿå°±æ˜¯éƒ¨åˆ†å’Œæ•´ä½“çš„å…³ç³»ï¼Œæœ€ç»å…¸çš„ç»„åˆæ¨¡å¼æè¿°å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€œéƒ¨åˆ†-æ•´ä½“â€çš„å±‚æ¬¡ç»“æ„ï¼Œä½¿å¾—ç”¨æˆ·å¯¹å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡çš„ä½¿ç”¨å…·æœ‰ä¸€è‡´æ€§ã€‚</p>
</blockquote>
<p>Goè¯­è¨€å¤©ç„¶å°±æ”¯æŒäº†ç»„åˆæ¨¡å¼ï¼Œè€Œä¸”ä»å®ƒä¸æ”¯æŒç»§æ‰¿å…³ç³»çš„ç‰¹ç‚¹æ¥çœ‹ï¼ŒGoä¹Ÿå¥‰è¡Œäº†<strong>ç»„åˆä¼˜äºç»§æ‰¿</strong>çš„åŸåˆ™ï¼Œé¼“åŠ±å¤§å®¶åœ¨è¿›è¡Œç¨‹åºè®¾è®¡æ—¶å¤šé‡‡ç”¨ç»„åˆçš„æ–¹æ³•ã€‚Goå®ç°ç»„åˆæ¨¡å¼çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯<strong>ç›´æ¥ç»„åˆ</strong>ï¼ˆDirect Compositionï¼‰å’Œ<strong>åµŒå…¥ç»„åˆ</strong>ï¼ˆEmbedding Compositionï¼‰ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¢è®¨è¿™ä¸¤ç§ä¸åŒçš„å®ç°æ–¹æ³•ã€‚</p>
<h3 id="goå®ç°">Goå®ç°</h3>
<p><em>ç›´æ¥ç»„åˆï¼ˆDirect Compositionï¼‰çš„å®ç°æ–¹å¼ç±»ä¼¼äºJava/C++ï¼Œå°±æ˜¯å°†ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå¦ä¸€ä¸ªå¯¹è±¡çš„æˆå‘˜å±æ€§ã€‚</em></p>
<p>ä¸€ä¸ªå…¸å‹çš„å®ç°å¦‚<a href="https://juejin.im/post/6859015515344633863">ã€Šä½¿ç”¨Goå®ç°GoFçš„23ç§è®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰ã€‹</a>ä¸­æ‰€ä¸¾çš„ä¾‹å­ï¼Œä¸€ä¸ª<code>Message</code>ç»“æ„ä½“ï¼Œç”±<code>Header</code>å’Œ<code>Body</code>æ‰€ç»„æˆã€‚é‚£ä¹ˆ<code>Message</code>å°±æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œè€Œ<code>Header</code>å’Œ<code>Body</code>åˆ™ä¸ºæ¶ˆæ¯çš„ç»„æˆéƒ¨åˆ†ã€‚</p>
<pre><code class="language-go">type Message struct {
    Header *Header
    Body   *Body
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç¨å¾®å¤æ‚ä¸€ç‚¹çš„ä¾‹å­ï¼ŒåŒæ ·è€ƒè™‘ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æ‰€æè¿°çš„æ’ä»¶æ¶æ„é£æ ¼çš„æ¶ˆæ¯å¤„ç†ç³»ç»Ÿã€‚å‰é¢æˆ‘ä»¬ç”¨<strong>æŠ½è±¡å·¥å‚æ¨¡å¼</strong>è§£å†³äº†æ’ä»¶åŠ è½½çš„é—®é¢˜ï¼Œé€šå¸¸ï¼Œæ¯ä¸ªæ’ä»¶éƒ½ä¼šæœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå¸¸è§çš„å°±æ˜¯å¯åŠ¨çŠ¶æ€å’Œåœæ­¢çŠ¶æ€ï¼Œç°åœ¨æˆ‘ä»¬ä½¿ç”¨<strong>ç»„åˆæ¨¡å¼</strong>æ¥è§£å†³æ’ä»¶çš„å¯åŠ¨å’Œåœæ­¢é—®é¢˜ã€‚</p>
<p>é¦–å…ˆç»™<code>Plugin</code>æ¥å£æ·»åŠ å‡ ä¸ªç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ–¹æ³•ï¼š</p>
<pre><code class="language-go">package plugin
...
// æ’ä»¶è¿è¡ŒçŠ¶æ€
type Status uint8

const (
    Stopped Status = iota
    Started
)

type Plugin interface {
  // å¯åŠ¨æ’ä»¶
    Start()
  // åœæ­¢æ’ä»¶
    Stop()
  // è¿”å›æ’ä»¶å½“å‰çš„è¿è¡ŒçŠ¶æ€
    Status() Status
}
// Inputã€Filterã€Outputä¸‰ç±»æ’ä»¶æ¥å£çš„å®šä¹‰è·Ÿä¸Šä¸€ç¯‡æ–‡ç« ç±»ä¼¼
// è¿™é‡Œä½¿ç”¨Messageç»“æ„ä½“æ›¿ä»£äº†åŸæ¥çš„stringï¼Œä½¿å¾—è¯­ä¹‰æ›´æ¸…æ™°
type Input interface {
    Plugin
    Receive() *msg.Message
}

type Filter interface {
    Plugin
    Process(msg *msg.Message) *msg.Message
}

type Output interface {
    Plugin
    Send(msg *msg.Message)
}

å¤åˆ¶ä»£ç 
</code></pre>
<p>å¯¹äºæ’ä»¶åŒ–çš„æ¶ˆæ¯å¤„ç†ç³»ç»Ÿè€Œè¨€ï¼Œä¸€åˆ‡çš†æ˜¯æ’ä»¶ï¼Œå› æ­¤æˆ‘ä»¬å°†<code>Pipeine</code>ä¹Ÿè®¾è®¡æˆä¸€ä¸ªæ’ä»¶ï¼Œå®ç°<code>Plugin</code>æ¥å£ï¼š</p>
<pre><code class="language-go">package pipeline
...
// ä¸€ä¸ªPipelineç”±inputã€filterã€outputä¸‰ä¸ªPluginç»„æˆ
type Pipeline struct {
    status plugin.Status
    input  plugin.Input
    filter plugin.Filter
    output plugin.Output
}

func (p *Pipeline) Exec() {
    msg := p.input.Receive()
    msg = p.filter.Process(msg)
    p.output.Send(msg)
}
// å¯åŠ¨çš„é¡ºåº output -&gt; filter -&gt; input
func (p *Pipeline) Start() {
    p.output.Start()
    p.filter.Start()
    p.input.Start()
    p.status = plugin.Started
    fmt.Println(&quot;Hello input plugin started.&quot;)
}
// åœæ­¢çš„é¡ºåº input -&gt; filter -&gt; output
func (p *Pipeline) Stop() {
    p.input.Stop()
    p.filter.Stop()
    p.output.Stop()
    p.status = plugin.Stopped
    fmt.Println(&quot;Hello input plugin stopped.&quot;)
}

func (p *Pipeline) Status() plugin.Status {
    return p.status
}

å¤åˆ¶ä»£ç 
</code></pre>
<p>ä¸€ä¸ª<code>Pipeline</code>ç”±<code>Input</code>ã€<code>Filter</code>ã€<code>Output</code>ä¸‰ç±»æ’ä»¶ç»„æˆï¼Œå½¢æˆäº†â€œéƒ¨åˆ†-æ•´ä½“â€çš„å…³ç³»ï¼Œè€Œä¸”å®ƒä»¬éƒ½å®ç°äº†<code>Plugin</code>æ¥å£ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ç»„åˆæ¨¡å¼çš„å®ç°ã€‚Clientæ— éœ€æ˜¾å¼åœ°å¯åŠ¨å’Œåœæ­¢<code>Input</code>ã€<code>Filter</code>å’Œ<code>Output</code>æ’ä»¶ï¼Œåœ¨è°ƒç”¨<code>Pipeline</code>å¯¹è±¡çš„<code>Start</code>å’Œ<code>Stop</code>æ–¹æ³•æ—¶ï¼Œ<code>Pipeline</code>å°±å·²ç»å¸®ä½ æŒ‰é¡ºåºå®Œæˆå¯¹åº”æ’ä»¶çš„å¯åŠ¨å’Œåœæ­¢ã€‚</p>
<p>ç›¸æ¯”äºä¸Šä¸€ç¯‡æ–‡ç« ï¼Œåœ¨æœ¬æ–‡ä¸­å®ç°<code>Input</code>ã€<code>Filter</code>ã€<code>Output</code>ä¸‰ç±»æ’ä»¶æ—¶ï¼Œéœ€è¦å¤šå®ç°3ä¸ªç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•ã€‚è¿˜æ˜¯ä»¥ä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„<code>HelloInput</code>ã€<code>UpperFilter</code>å’Œ<code>ConsoleOutput</code>ä½œä¸ºä¾‹å­ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package plugin
...
type HelloInput struct {
    status Status
}

func (h *HelloInput) Receive() *msg.Message {
  // å¦‚æœæ’ä»¶æœªå¯åŠ¨ï¼Œåˆ™è¿”å›nil
    if h.status != Started {
        fmt.Println(&quot;Hello input plugin is not running, input nothing.&quot;)
        return nil
    }
    return msg.Builder().
        WithHeaderItem(&quot;content&quot;, &quot;text&quot;).
        WithBodyItem(&quot;Hello World&quot;).
        Build()
}

func (h *HelloInput) Start() {
    h.status = Started
    fmt.Println(&quot;Hello input plugin started.&quot;)
}

func (h *HelloInput) Stop() {
    h.status = Stopped
    fmt.Println(&quot;Hello input plugin stopped.&quot;)
}

func (h *HelloInput) Status() Status {
    return h.status
}
å¤åˆ¶ä»£ç 
package plugin
...
type UpperFilter struct {
    status Status
}

func (u *UpperFilter) Process(msg *msg.Message) *msg.Message {
    if u.status != Started {
        fmt.Println(&quot;Upper filter plugin is not running, filter nothing.&quot;)
        return msg
    }
    for i, val := range msg.Body.Items {
        msg.Body.Items[i] = strings.ToUpper(val)
    }
    return msg
}

func (u *UpperFilter) Start() {
    u.status = Started
    fmt.Println(&quot;Upper filter plugin started.&quot;)
}

func (u *UpperFilter) Stop() {
    u.status = Stopped
    fmt.Println(&quot;Upper filter plugin stopped.&quot;)
}

func (u *UpperFilter) Status() Status {
    return u.status
}

å¤åˆ¶ä»£ç 
package plugin
...
type ConsoleOutput struct {
    status Status
}

func (c *ConsoleOutput) Send(msg *msg.Message) {
    if c.status != Started {
        fmt.Println(&quot;Console output is not running, output nothing.&quot;)
        return
    }
    fmt.Printf(&quot;Output:\n\tHeader:%+v, Body:%+v\n&quot;, msg.Header.Items, msg.Body.Items)
}

func (c *ConsoleOutput) Start() {
    c.status = Started
    fmt.Println(&quot;Console output plugin started.&quot;)
}

func (c *ConsoleOutput) Stop() {
    c.status = Stopped
    fmt.Println(&quot;Console output plugin stopped.&quot;)
}

func (c *ConsoleOutput) Status() Status {
    return c.status
}

å¤åˆ¶ä»£ç 
</code></pre>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package test
...
func TestPipeline(t *testing.T) {
    p := pipeline.Of(pipeline.DefaultConfig())
    p.Start()
    p.Exec()
    p.Stop()
}
// è¿è¡Œç»“æœ
=== RUN   TestPipeline
Console output plugin started.
Upper filter plugin started.
Hello input plugin started.
Pipeline started.
Output:
    Header:map[content:text], Body:[HELLO WORLD]
Hello input plugin stopped.
Upper filter plugin stopped.
Console output plugin stopped.
Hello input plugin stopped.
--- PASS: TestPipeline (0.00s)
PASS
å¤åˆ¶ä»£ç 
</code></pre>
<p><em>ç»„åˆæ¨¡å¼çš„å¦ä¸€ç§å®ç°ï¼ŒåµŒå…¥ç»„åˆï¼ˆEmbedding Compositionï¼‰ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨äº†Goè¯­è¨€çš„åŒ¿åæˆå‘˜ç‰¹æ€§ï¼Œæœ¬è´¨ä¸Šè·Ÿç›´æ¥ç»„åˆæ˜¯ä¸€è‡´çš„ã€‚</em></p>
<p>è¿˜æ˜¯ä»¥Messageç»“æ„ä½“ä¸ºä¾‹ï¼Œå¦‚æœé‡‡ç”¨åµŒå…¥ç»„åˆï¼Œåˆ™çœ‹èµ·æ¥åƒæ˜¯è¿™æ ·ï¼š</p>
<pre><code class="language-go">type Message struct {
    Header
    Body
}
// ä½¿ç”¨æ—¶ï¼ŒMessageå¯ä»¥å¼•ç”¨Headerå’ŒBodyçš„æˆå‘˜å±æ€§ï¼Œä¾‹å¦‚ï¼š
msg := &amp;Message{}
msg.SrcAddr = &quot;192.168.0.1&quot;
å¤åˆ¶ä»£ç 
</code></pre>
<h2 id="é€‚é…å™¨æ¨¡å¼adapter-pattern">é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰</h2>
<figure data-type="image" tabindex="2"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghzyia5t19j315w0k0kjl.jpg" alt="é€‚é…å™¨æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<h3 id="ç®€è¿°-2">ç®€è¿°</h3>
<p>é€‚é…å™¨æ¨¡å¼æ˜¯æœ€å¸¸ç”¨çš„ç»“æ„å‹æ¨¡å¼ä¹‹ä¸€ï¼Œå®ƒè®©åŸæœ¬å› ä¸ºæ¥å£ä¸åŒ¹é…è€Œæ— æ³•ä¸€èµ·å·¥ä½œçš„ä¸¤ä¸ªå¯¹è±¡èƒ½å¤Ÿä¸€èµ·å·¥ä½œã€‚åœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œé€‚é…å™¨æ¨¡å¼ä¹Ÿæ˜¯å¤„å¤„å¯è§ï¼Œæ¯”å¦‚ç”µæºæ’å¤´è½¬æ¢å™¨ï¼Œå¯ä»¥è®©è‹±å¼çš„æ’å¤´å·¥ä½œåœ¨ä¸­å¼çš„æ’åº§ä¸Šã€‚é€‚é…å™¨æ¨¡å¼æ‰€åšçš„å°±æ˜¯<strong>å°†ä¸€ä¸ªæ¥å£<code>Adaptee</code>ï¼Œé€šè¿‡é€‚é…å™¨<code>Adapter</code>è½¬æ¢æˆClientæ‰€æœŸæœ›çš„å¦ä¸€ä¸ªæ¥å£<code>Target</code>æ¥ä½¿ç”¨</strong>ï¼Œå®ç°åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯<code>Adapter</code>é€šè¿‡å®ç°<code>Target</code>æ¥å£ï¼Œå¹¶åœ¨å¯¹åº”çš„æ–¹æ³•ä¸­è°ƒç”¨<code>Adaptee</code>çš„æ¥å£å®ç°ã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯æ˜¯ï¼Œ<em>ç³»ç»Ÿä¸­ä¸€ä¸ªè€çš„æ¥å£å·²ç»è¿‡æ—¶å³å°†åºŸå¼ƒï¼Œä½†å› ä¸ºå†å²åŒ…è¢±æ²¡æ³•ç«‹å³å°†è€æ¥å£å…¨éƒ¨æ›¿æ¢ä¸ºæ–°æ¥å£ï¼Œè¿™æ—¶å¯ä»¥æ–°å¢ä¸€ä¸ªé€‚é…å™¨ï¼Œå°†è€çš„æ¥å£é€‚é…æˆæ–°çš„æ¥å£æ¥ä½¿ç”¨</em>ã€‚é€‚é…å™¨æ¨¡å¼å¾ˆå¥½çš„è·µè¡Œäº†é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™é‡Œçš„<strong>å¼€é—­åŸåˆ™</strong>ï¼ˆopen/closed principleï¼‰ï¼Œæ–°å¢ä¸€ä¸ªæ¥å£æ—¶ä¹Ÿæ— éœ€ä¿®æ”¹è€æ¥å£ï¼Œåªéœ€å¤šåŠ ä¸€ä¸ªé€‚é…å±‚å³å¯ã€‚</p>
<h3 id="goå®ç°-2">Goå®ç°</h3>
<p>ç»§ç»­è€ƒè™‘ä¸Šä¸€èŠ‚çš„æ¶ˆæ¯å¤„ç†ç³»ç»Ÿä¾‹å­ï¼Œç›®å‰ä¸ºæ­¢ï¼Œç³»ç»Ÿçš„è¾“å…¥éƒ½æºè‡ªäº<code>HelloInput</code>ï¼Œç°åœ¨å‡è®¾éœ€è¦ç»™ç³»ç»Ÿæ–°å¢ä»Kafkaæ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶æ•°æ®çš„åŠŸèƒ½ï¼Œå…¶ä¸­Kafkaæ¶ˆè´¹è€…çš„æ¥å£å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package kafka
...
type Records struct {
    Items []string
}

type Consumer interface {
    Poll() Records
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>ç”±äºå½“å‰<code>Pipeline</code>çš„è®¾è®¡æ˜¯é€šè¿‡<code>plugin.Input</code>æ¥å£æ¥è¿›è¡Œæ•°æ®æ¥æ”¶ï¼Œå› æ­¤<code>kafka.Consumer</code>å¹¶ä¸èƒ½ç›´æ¥é›†æˆåˆ°ç³»ç»Ÿä¸­ã€‚</p>
<p><em>æ€ä¹ˆåŠï¼Ÿä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼</em></p>
<p>ä¸ºäº†èƒ½è®©<code>Pipeline</code>èƒ½å¤Ÿä½¿ç”¨<code>kafka.Consumer</code>æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªé€‚é…å™¨å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package plugin
...
type KafkaInput struct {
    status Status
    consumer kafka.Consumer
}

func (k *KafkaInput) Receive() *msg.Message {
    records := k.consumer.Poll()
    if k.status != Started {
        fmt.Println(&quot;Kafka input plugin is not running, input nothing.&quot;)
        return nil
    }
    return msg.Builder().
        WithHeaderItem(&quot;content&quot;, &quot;kafka&quot;).
        WithBodyItems(records.Items).
        Build()
}

// åœ¨è¾“å…¥æ’ä»¶æ˜ å°„å…³ç³»ä¸­åŠ å…¥kafkaï¼Œç”¨äºé€šè¿‡åå°„åˆ›å»ºinputå¯¹è±¡
func init() {
    inputNames[&quot;hello&quot;] = reflect.TypeOf(HelloInput{})
    inputNames[&quot;kafka&quot;] = reflect.TypeOf(KafkaInput{})
}
...
å¤åˆ¶ä»£ç 
</code></pre>
<p>å› ä¸ºGoè¯­è¨€å¹¶æ²¡æœ‰æ„é€ å‡½æ•°ï¼Œå¦‚æœæŒ‰ç…§ä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„<strong>æŠ½è±¡å·¥å‚æ¨¡å¼</strong>æ¥åˆ›å»º<code>KafkaInput</code>ï¼Œé‚£ä¹ˆå¾—åˆ°çš„å®ä¾‹ä¸­çš„<code>consumer</code>æˆå‘˜å› ä¸ºæ²¡æœ‰è¢«åˆå§‹åŒ–è€Œä¼šæ˜¯<code>nil</code>ã€‚å› æ­¤ï¼Œéœ€è¦ç»™<code>Plugin</code>æ¥å£æ–°å¢ä¸€ä¸ª<code>Init</code>æ–¹æ³•ï¼Œç”¨äºå®šä¹‰æ’ä»¶çš„ä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¹¶åœ¨å·¥å‚è¿”å›å®ä¾‹å‰è°ƒç”¨ã€‚</p>
<pre><code class="language-go">package plugin
...
type Plugin interface {
    Start()
    Stop()
    Status() Status
    // æ–°å¢åˆå§‹åŒ–æ–¹æ³•ï¼Œåœ¨æ’ä»¶å·¥å‚è¿”å›å®ä¾‹å‰è°ƒç”¨
    Init()
}

// ä¿®æ”¹åçš„æ’ä»¶å·¥å‚å®ç°å¦‚ä¸‹
func (i *InputFactory) Create(conf Config) Plugin {
    t, _ := inputNames[conf.Name]
    p := reflect.New(t).Interface().(Plugin)
  // è¿”å›æ’ä»¶å®ä¾‹å‰è°ƒç”¨Initå‡½æ•°ï¼Œå®Œæˆç›¸å…³åˆå§‹åŒ–æ–¹æ³•
    p.Init()
    return p
}

// KakkaInputçš„Initå‡½æ•°å®ç°
func (k *KafkaInput) Init() {
    k.consumer = &amp;kafka.MockConsumer{}
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>ä¸Šè¿°ä»£ç ä¸­çš„<code>kafka.MockConsumer</code>ä¸ºæˆ‘ä»¬æ¨¡å¼Kafkaæ¶ˆè´¹è€…çš„ä¸€ä¸ªå®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package kafka
...
type MockConsumer struct {}

func (m *MockConsumer) Poll() *Records {
    records := &amp;Records{}
    records.Items = append(records.Items, &quot;i am mock consumer.&quot;)
    return records
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package test
...
func TestKafkaInputPipeline(t *testing.T) {
    config := pipeline.Config{
        Name: &quot;pipeline2&quot;,
        Input: plugin.Config{
            PluginType: plugin.InputType,
            Name:       &quot;kafka&quot;,
        },
        Filter: plugin.Config{
            PluginType: plugin.FilterType,
            Name:       &quot;upper&quot;,
        },
        Output: plugin.Config{
            PluginType: plugin.OutputType,
            Name:       &quot;console&quot;,
        },
    }
    p := pipeline.Of(config)
    p.Start()
    p.Exec()
    p.Stop()
}
// è¿è¡Œç»“æœ
=== RUN   TestKafkaInputPipeline
Console output plugin started.
Upper filter plugin started.
Kafka input plugin started.
Pipeline started.
Output:
    Header:map[content:kafka], Body:[I AM MOCK CONSUMER.]
Kafka input plugin stopped.
Upper filter plugin stopped.
Console output plugin stopped.
Pipeline stopped.
--- PASS: TestKafkaInputPipeline (0.00s)
PASS
å¤åˆ¶ä»£ç 
</code></pre>
<h2 id="æ¡¥æ¥æ¨¡å¼bridge-pattern">æ¡¥æ¥æ¨¡å¼ï¼ˆBridge Patternï¼‰</h2>
<figure data-type="image" tabindex="3"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi00awfcxcj31f20l01ky.jpg" alt="æ¡¥æ¥æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<h3 id="ç®€è¿°-3">ç®€è¿°</h3>
<p>æ¡¥æ¥æ¨¡å¼ä¸»è¦ç”¨äº<strong>å°†æŠ½è±¡éƒ¨åˆ†å’Œå®ç°éƒ¨åˆ†è¿›è¡Œè§£è€¦ï¼Œä½¿å¾—å®ƒä»¬èƒ½å¤Ÿå„è‡ªå¾€ç‹¬ç«‹çš„æ–¹å‘å˜åŒ–</strong>ã€‚å®ƒè§£å†³äº†åœ¨æ¨¡å—æœ‰å¤šç§å˜åŒ–æ–¹å‘çš„æƒ…å†µä¸‹ï¼Œç”¨ç»§æ‰¿æ‰€å¯¼è‡´çš„ç±»çˆ†ç‚¸é—®é¢˜ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä¸€ä¸ªäº§å“æœ‰å½¢çŠ¶å’Œé¢œè‰²ä¸¤ä¸ªç‰¹å¾ï¼ˆå˜åŒ–æ–¹å‘ï¼‰ï¼Œå…¶ä¸­å½¢çŠ¶åˆ†ä¸ºæ–¹å½¢å’Œåœ†å½¢ï¼Œé¢œè‰²åˆ†ä¸ºçº¢è‰²å’Œè“è‰²ã€‚å¦‚æœé‡‡ç”¨ç»§æ‰¿çš„è®¾è®¡æ–¹æ¡ˆï¼Œé‚£ä¹ˆå°±éœ€è¦æ–°å¢4ä¸ªäº§å“å­ç±»ï¼šæ–¹å½¢çº¢è‰²ã€åœ†å½¢çº¢è‰²ã€æ–¹å½¢è“è‰²ã€åœ†å½¢çº¢è‰²ã€‚å¦‚æœå½¢çŠ¶æ€»å…±æœ‰mç§å˜åŒ–ï¼Œé¢œè‰²æœ‰nç§å˜åŒ–ï¼Œé‚£ä¹ˆå°±éœ€è¦æ–°å¢m*nä¸ªäº§å“å­ç±»ï¼ç°åœ¨æˆ‘ä»¬ä½¿ç”¨æ¡¥æ¥æ¨¡å¼è¿›è¡Œä¼˜åŒ–ï¼Œå°†å½¢çŠ¶å’Œé¢œè‰²åˆ†åˆ«è®¾è®¡ä¸ºä¸€ä¸ªæŠ½è±¡æ¥å£ç‹¬ç«‹å‡ºæ¥ï¼Œè¿™æ ·éœ€è¦æ–°å¢2ä¸ªå½¢çŠ¶å­ç±»ï¼šæ–¹å½¢å’Œåœ†å½¢ï¼Œä»¥åŠ2ä¸ªé¢œè‰²å­ç±»ï¼šçº¢è‰²å’Œè“è‰²ã€‚åŒæ ·ï¼Œå¦‚æœå½¢çŠ¶æ€»å…±æœ‰mç§å˜åŒ–ï¼Œé¢œè‰²æœ‰nç§å˜åŒ–ï¼Œæ€»å…±åªéœ€è¦æ–°å¢m+nä¸ªå­ç±»ï¼</p>
<figure data-type="image" tabindex="4"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi01kwmua8j31hs0s47wj.jpg" alt="æ¡¥æ¥æ¨¡å¼ç¤ºä¾‹" loading="lazy"></figure>
<p>ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å°†å½¢çŠ¶å’Œé¢œè‰²æŠ½è±¡ä¸ºä¸€ä¸ªæ¥å£ï¼Œä½¿äº§å“ä¸å†ä¾èµ–äºå…·ä½“çš„å½¢çŠ¶å’Œé¢œè‰²ç»†èŠ‚ï¼Œä»è€Œè¾¾åˆ°äº†è§£è€¦çš„ç›®çš„ã€‚<strong>æ¡¥æ¥æ¨¡å¼æœ¬è´¨ä¸Šå°±æ˜¯é¢å‘æ¥å£ç¼–ç¨‹ï¼Œå¯ä»¥ç»™ç³»ç»Ÿå¸¦æ¥å¾ˆå¥½çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§</strong>ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡å­˜åœ¨å¤šä¸ªå˜åŒ–çš„æ–¹å‘ï¼Œè€Œä¸”æ¯ä¸ªå˜åŒ–æ–¹å‘éƒ½éœ€è¦æ‰©å±•ï¼Œé‚£ä¹ˆä½¿ç”¨æ¡¥æ¥æ¨¡å¼è¿›è¡Œè®¾è®¡é‚£æ˜¯å†åˆé€‚ä¸è¿‡äº†ã€‚</p>
<h3 id="goå®ç°-3">Goå®ç°</h3>
<p>å›åˆ°æ¶ˆæ¯å¤„ç†ç³»ç»Ÿçš„ä¾‹å­ï¼Œä¸€ä¸ª<code>Pipeline</code>å¯¹è±¡ä¸»è¦ç”±<code>Input</code>ã€<code>Filter</code>ã€<code>Output</code>ä¸‰ç±»æ’ä»¶ç»„æˆï¼ˆ<strong>3ä¸ªç‰¹å¾</strong>ï¼‰ï¼Œå› ä¸ºæ˜¯æ’ä»¶åŒ–çš„ç³»ç»Ÿï¼Œä¸å¯é¿å…çš„å°±è¦æ±‚æ”¯æŒå¤šç§<code>Input</code>ã€<code>Filter</code>ã€<code>Output</code>çš„å®ç°ï¼Œå¹¶èƒ½å¤Ÿçµæ´»ç»„åˆï¼ˆ<strong>æœ‰å¤šä¸ªå˜åŒ–çš„æ–¹å‘</strong>ï¼‰ã€‚æ˜¾ç„¶ï¼Œ<code>Pipeline</code>å°±éå¸¸é€‚åˆä½¿ç”¨æ¡¥æ¥æ¨¡å¼è¿›è¡Œè®¾è®¡ï¼Œå®é™…ä¸Šæˆ‘ä»¬ä¹Ÿè¿™ä¹ˆåšäº†ã€‚æˆ‘ä»¬å°†<code>Input</code>ã€<code>Filter</code>ã€<code>Output</code>åˆ†åˆ«è®¾è®¡æˆä¸€ä¸ªæŠ½è±¡çš„æ¥å£ï¼Œå®ƒä»¬æŒ‰ç…§å„è‡ªçš„æ–¹å‘å»æ‰©å±•ã€‚<code>Pipeline</code>åªä¾èµ–çš„è¿™3ä¸ªæŠ½è±¡æ¥å£ï¼Œå¹¶ä¸æ„ŸçŸ¥å…·ä½“å®ç°çš„ç»†èŠ‚ã€‚</p>
<figure data-type="image" tabindex="5"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gi0i6xpj9sj318a0nk4qq.jpg" alt="ä½¿ç”¨æ¡¥æ¥æ¨¡å¼è®¾è®¡çš„Pipeline" loading="lazy"></figure>
<pre><code class="language-go">package plugin
...
type Input interface {
    Plugin
    Receive() *msg.Message
}

type Filter interface {
    Plugin
    Process(msg *msg.Message) *msg.Message
}

type Output interface {
    Plugin
    Send(msg *msg.Message)
}
å¤åˆ¶ä»£ç 
package pipeline
...
// ä¸€ä¸ªPipelineç”±inputã€filterã€outputä¸‰ä¸ªPluginç»„æˆ
type Pipeline struct {
    status plugin.Status
    input  plugin.Input
    filter plugin.Filter
    output plugin.Output
}
// é€šè¿‡æŠ½è±¡æ¥å£æ¥ä½¿ç”¨ï¼Œçœ‹ä¸åˆ°åº•å±‚çš„å®ç°ç»†èŠ‚
func (p *Pipeline) Exec() {
    msg := p.input.Receive()
    msg = p.filter.Process(msg)
    p.output.Send(msg)
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package test
...
func TestPipeline(t *testing.T) {
    p := pipeline.Of(pipeline.DefaultConfig())
    p.Start()
    p.Exec()
    p.Stop()
}
// è¿è¡Œç»“æœ
=== RUN   TestPipeline
Console output plugin started.
Upper filter plugin started.
Hello input plugin started.
Pipeline started.
Output:
    Header:map[content:text], Body:[HELLO WORLD]
Hello input plugin stopped.
Upper filter plugin stopped.
Console output plugin stopped.
Pipeline stopped.
--- PASS: TestPipeline (0.00s)
PASS
å¤åˆ¶ä»£ç 
</code></pre>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº†ç»“æ„å‹æ¨¡å¼ä¸­çš„ç»„åˆæ¨¡å¼ã€é€‚é…å™¨æ¨¡å¼å’Œæ¡¥æ¥æ¨¡å¼ã€‚<strong>ç»„åˆæ¨¡å¼</strong>ä¸»è¦è§£å†³ä»£ç å¤ç”¨çš„é—®é¢˜ï¼Œç›¸æ¯”äºç»§æ‰¿å…³ç³»ï¼Œç»„åˆæ¨¡å¼å¯ä»¥é¿å…ç»§æ‰¿å±‚æ¬¡è¿‡æ·±å¯¼è‡´çš„ä»£ç å¤æ‚é—®é¢˜ï¼Œå› æ­¤é¢å‘å¯¹è±¡è®¾è®¡é¢†åŸŸæµä¼ ç€<strong>ç»„åˆä¼˜äºç»§æ‰¿</strong>çš„åŸåˆ™ï¼Œè€ŒGoè¯­è¨€çš„è®¾è®¡ä¹Ÿå¾ˆå¥½å®è·µäº†è¯¥åŸåˆ™ï¼›<strong>é€‚é…å™¨æ¨¡å¼</strong>å¯ä»¥çœ‹ä½œæ˜¯ä¸¤ä¸ªä¸å…¼å®¹æ¥å£ä¹‹é—´çš„æ¡¥æ¢ï¼Œå¯ä»¥å°†ä¸€ä¸ªæ¥å£è½¬æ¢æˆClientæ‰€å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ï¼Œè§£å†³äº†æ¨¡å—ä¹‹é—´å› ä¸ºæ¥å£ä¸å…¼å®¹è€Œæ— æ³•ä¸€èµ·å·¥ä½œçš„é—®é¢˜ï¼›<strong>æ¡¥æ¥æ¨¡å¼</strong>å°†æ¨¡å—çš„æŠ½è±¡éƒ¨åˆ†å’Œå®ç°éƒ¨åˆ†è¿›è¡Œåˆ†ç¦»ï¼Œè®©å®ƒä»¬èƒ½å¤Ÿå¾€å„è‡ªçš„æ–¹å‘æ‰©å±•ï¼Œä»è€Œè¾¾åˆ°è§£è€¦çš„ç›®çš„ã€‚</p>
<p>ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†ç»§ç»­èšç„¦äºç»“æ„å‹æ¨¡å¼ï¼Œä»‹ç»å®Œå‰©ä½™çš„4ç§ç»“æ¨¡å¼ï¼šè£…é¥°æ¨¡å¼ã€å¤–è§‚æ¨¡å¼ã€äº«å…ƒæ¨¡å¼å’Œä»£ç†æ¨¡å¼ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä½¿ç”¨Goå®ç°GoFçš„23ç§è®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰]]></title>
        <id>https://ChicRingo.github.io/post/shi-yong-go-shi-xian-gof-de-23-chong-she-ji-mo-shi-yi/</id>
        <link href="https://ChicRingo.github.io/post/shi-yong-go-shi-xian-gof-de-23-chong-she-ji-mo-shi-yi/">
        </link>
        <updated>2020-08-28T15:14:07.000Z</updated>
        <summary type="html"><![CDATA[<p>ä½œè€…ï¼šå…ƒé—°å­<br>
é“¾æ¥ï¼šhttps://juejin.im/post/6859015515344633863<br>
æ¥æºï¼šæ˜é‡‘<br>
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>ä½œè€…ï¼šå…ƒé—°å­<br>
é“¾æ¥ï¼šhttps://juejin.im/post/6859015515344633863<br>
æ¥æºï¼šæ˜é‡‘<br>
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
<!-- more -->
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>ä»1995å¹´GoFæå‡º23ç§<strong>è®¾è®¡æ¨¡å¼</strong>åˆ°ç°åœ¨ï¼Œ25å¹´è¿‡å»äº†ï¼Œè®¾è®¡æ¨¡å¼ä¾æ—§æ˜¯è½¯ä»¶é¢†åŸŸçš„çƒ­é—¨è¯é¢˜ã€‚åœ¨å½“ä¸‹ï¼Œå¦‚æœä½ ä¸ä¼šä¸€ç‚¹è®¾è®¡æ¨¡å¼ï¼Œéƒ½ä¸å¥½æ„æ€è¯´è‡ªå·±æ˜¯ä¸€ä¸ªåˆæ ¼çš„ç¨‹åºå‘˜ã€‚è®¾è®¡æ¨¡å¼é€šå¸¸è¢«å®šä¹‰ä¸ºï¼š</p>
<blockquote>
<p>è®¾è®¡æ¨¡å¼ï¼ˆDesign Patternï¼‰æ˜¯ä¸€å¥—è¢«åå¤ä½¿ç”¨ã€å¤šæ•°äººçŸ¥æ™“çš„ã€ç»è¿‡åˆ†ç±»ç¼–ç›®çš„ã€ä»£ç è®¾è®¡ç»éªŒçš„æ€»ç»“ï¼Œä½¿ç”¨è®¾è®¡æ¨¡å¼æ˜¯ä¸ºäº†å¯é‡ç”¨ä»£ç ã€è®©ä»£ç æ›´å®¹æ˜“è¢«ä»–äººç†è§£å¹¶ä¸”ä¿è¯ä»£ç å¯é æ€§ã€‚</p>
</blockquote>
<p>ä»å®šä¹‰ä¸Šçœ‹ï¼Œ<strong>è®¾è®¡æ¨¡å¼å…¶å®æ˜¯ä¸€ç§ç»éªŒçš„æ€»ç»“ï¼Œæ˜¯é’ˆå¯¹ç‰¹å®šé—®é¢˜çš„ç®€æ´è€Œä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ</strong>ã€‚æ—¢ç„¶æ˜¯ç»éªŒæ€»ç»“ï¼Œé‚£ä¹ˆå­¦ä¹ è®¾è®¡æ¨¡å¼æœ€ç›´æ¥çš„å¥½å¤„å°±åœ¨äºå¯ä»¥ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šè§£å†³è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­çš„ä¸€äº›ç‰¹å®šé—®é¢˜ã€‚ç„¶è€Œï¼Œå­¦ä¹ è®¾è®¡æ¨¡å¼çš„æœ€é«˜å¢ƒç•Œæ˜¯ä¹ å¾—å…¶ä¸­è§£å†³é—®é¢˜æ‰€ç”¨åˆ°çš„æ€æƒ³ï¼Œå½“ä½ æŠŠå®ƒä»¬çš„æœ¬è´¨æ€æƒ³åƒé€äº†ï¼Œä¹Ÿå°±èƒ½åšåˆ°<strong>å³ä½¿å·²ç»å¿˜æ‰æŸä¸ªè®¾è®¡æ¨¡å¼çš„åç§°å’Œç»“æ„ï¼Œä¹Ÿèƒ½åœ¨è§£å†³ç‰¹å®šé—®é¢˜æ—¶ä¿¡æ‰‹æ‹ˆæ¥</strong>ã€‚</p>
<p>å¥½çš„ä¸œè¥¿æœ‰äººå¹æ§ï¼Œå½“ç„¶ä¹Ÿä¼šæ‹›é»‘ã€‚è®¾è®¡æ¨¡å¼è¢«æŠ¨å‡»ä¸»è¦å› ä¸ºä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<p>1ã€<em>è®¾è®¡æ¨¡å¼ä¼šå¢åŠ ä»£ç é‡ï¼ŒæŠŠç¨‹åºé€»è¾‘å˜å¾—å¤æ‚</em>ã€‚è¿™ä¸€ç‚¹æ˜¯ä¸å¯é¿å…çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸èƒ½ä»…ä»…åªè€ƒè™‘å¼€å‘é˜¶æ®µçš„æˆæœ¬ã€‚æœ€ç®€å•çš„ç¨‹åºå½“ç„¶æ˜¯ä¸€ä¸ªå‡½æ•°ä»å¤´å†™åˆ°å°¾ï¼Œä½†æ˜¯è¿™æ ·åæœŸçš„ç»´æŠ¤æˆæœ¬ä¼šå˜å¾—éå¸¸å¤§ï¼›è€Œè®¾è®¡æ¨¡å¼è™½ç„¶å¢åŠ äº†ä¸€ç‚¹å¼€å‘æˆæœ¬ï¼Œä½†æ˜¯èƒ½è®©äººä»¬å†™å‡ºå¯å¤ç”¨ã€å¯ç»´æŠ¤æ€§é«˜çš„ç¨‹åºã€‚å¼•ç”¨ã€Šè½¯ä»¶è®¾è®¡çš„å“²å­¦ã€‹é‡Œçš„æ¦‚å¿µï¼Œå‰è€…å°±æ˜¯<strong>æˆ˜æœ¯ç¼–ç¨‹</strong>ï¼Œåè€…å°±æ˜¯<strong>æˆ˜ç•¥ç¼–ç¨‹</strong>ï¼Œæˆ‘ä»¬åº”è¯¥<strong>å¯¹æˆ˜æœ¯ç¼–ç¨‹Say No</strong>ï¼ï¼ˆè¯·ç§»æ­¥<a href="https://www.yrunz.com/archives/%E4%B8%80%E6%AD%A5%E6%AD%A5%E9%99%8D%E4%BD%8E%E8%BD%AF%E4%BB%B6%E5%A4%8D%E6%9D%82%E6%80%A7">ã€Šä¸€æ­¥æ­¥é™ä½è½¯ä»¶å¤æ‚æ€§ã€‹</a>ï¼‰</p>
<p>2ã€<em>æ»¥ç”¨è®¾è®¡æ¨¡å¼</em>ã€‚è¿™æ˜¯åˆå­¦è€…æœ€å®¹æ˜“çŠ¯çš„é”™è¯¯ï¼Œå½“å­¦åˆ°ä¸€ä¸ªæ¨¡å¼æ—¶ï¼Œæ¨ä¸å¾—åœ¨æ‰€æœ‰çš„ä»£ç éƒ½ç”¨ä¸Šï¼Œä»è€Œåœ¨ä¸è¯¥ä½¿ç”¨æ¨¡å¼çš„åœ°æ–¹åˆ»æ„åœ°ä½¿ç”¨äº†æ¨¡å¼ï¼Œå¯¼è‡´äº†ç¨‹åºå˜å¾—å¼‚å¸¸å¤æ‚ã€‚å…¶å®æ¯ä¸ªè®¾è®¡æ¨¡å¼éƒ½æœ‰å‡ ä¸ªå…³é”®è¦ç´ ï¼š<strong>é€‚ç”¨åœºæ™¯</strong>ã€<strong>è§£å†³æ–¹æ³•</strong>ã€<strong>ä¼˜ç¼ºç‚¹</strong>ã€‚æ¨¡å¼å¹¶ä¸æ˜¯ä¸‡èƒ½è¯ï¼Œå®ƒåªæœ‰åœ¨ç‰¹å®šçš„é—®é¢˜ä¸Šæ‰èƒ½æ˜¾ç°å‡ºæ•ˆæœã€‚æ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨ä¸€ä¸ªæ¨¡å¼å‰ï¼Œå…ˆé—®é—®è‡ªå·±ï¼Œå½“å‰çš„è¿™ä¸ªåœºæ™¯é€‚ç”¨è¿™ä¸ªæ¨¡å¼å—ï¼Ÿ</p>
<p>ã€Šè®¾è®¡æ¨¡å¼ã€‹ä¸€ä¹¦çš„å‰¯æ ‡é¢˜æ˜¯â€œå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€â€ï¼Œä½†å¹¶ä¸æ„å‘³ç€åªæœ‰é¢å‘å¯¹è±¡è¯­è¨€æ‰èƒ½ä½¿ç”¨è®¾è®¡æ¨¡å¼ã€‚æ¨¡å¼åªæ˜¯ä¸€ç§è§£å†³ç‰¹å®šé—®é¢˜çš„æ€æƒ³ï¼Œè·Ÿè¯­è¨€æ— å…³ã€‚å°±åƒGoè¯­è¨€ä¸€æ ·ï¼Œå®ƒå¹¶éæ˜¯åƒC++å’ŒJavaä¸€æ ·çš„é¢å‘å¯¹è±¡è¯­è¨€ï¼Œä½†æ˜¯è®¾è®¡æ¨¡å¼åŒæ ·é€‚ç”¨ã€‚æœ¬ç³»åˆ—æ–‡ç« å°†ä½¿ç”¨Goè¯­è¨€æ¥å®ç°GoFæå‡ºçš„23ç§è®¾è®¡æ¨¡å¼ï¼ŒæŒ‰ç…§<strong>åˆ›å»ºå‹æ¨¡å¼</strong>ï¼ˆCreational Patternï¼‰ã€<strong>ç»“æ„å‹æ¨¡å¼</strong>ï¼ˆStructural Patternï¼‰å’Œ<strong>è¡Œä¸ºå‹æ¨¡å¼</strong>ï¼ˆBehavioral Patternï¼‰ä¸‰ç§ç±»åˆ«è¿›è¡Œç»„ç»‡ï¼Œæ–‡æœ¬ä¸»è¦ä»‹ç»å…¶ä¸­çš„åˆ›å»ºå‹æ¨¡å¼ã€‚</p>
<h2 id="å•ä¾‹æ¨¡å¼singleton-pattern">å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰</h2>
<figure data-type="image" tabindex="1"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghky3yanabj318q0iwnpd.jpg" alt="å•ä¾‹æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<h3 id="ç®€è¿°">ç®€è¿°</h3>
<p>å•ä¾‹æ¨¡å¼ç®—æ˜¯23ä¸­è®¾è®¡æ¨¡å¼é‡Œæœ€ç®€å•çš„ä¸€ä¸ªäº†ï¼Œå®ƒä¸»è¦ç”¨äº<strong>ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹</strong>ã€‚</p>
<p>åœ¨ç¨‹åºè®¾è®¡ä¸­ï¼Œæœ‰ä¸€äº›å¯¹è±¡é€šå¸¸æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªå…±äº«çš„å®ä¾‹ï¼Œæ¯”å¦‚çº¿ç¨‹æ± ã€å…¨å±€ç¼“å­˜ã€å¯¹è±¡æ± ç­‰ï¼Œè¿™ç§åœºæ™¯ä¸‹å°±é€‚åˆä½¿ç”¨å•ä¾‹æ¨¡å¼ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¹¶éæ‰€æœ‰å…¨å±€å”¯ä¸€çš„åœºæ™¯éƒ½é€‚åˆä½¿ç”¨å•ä¾‹æ¨¡å¼ã€‚æ¯”å¦‚ï¼Œè€ƒè™‘éœ€è¦ç»Ÿè®¡ä¸€ä¸ªAPIè°ƒç”¨çš„æƒ…å†µï¼Œæœ‰ä¸¤ä¸ªæŒ‡æ ‡ï¼ŒæˆåŠŸè°ƒç”¨æ¬¡æ•°å’Œå¤±è´¥è°ƒç”¨æ¬¡æ•°ã€‚è¿™ä¸¤ä¸ªæŒ‡æ ‡éƒ½æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œæ‰€ä»¥æœ‰äººå¯èƒ½ä¼šå°†å…¶å»ºæ¨¡æˆä¸¤ä¸ªå•ä¾‹<code>SuccessApiMetric</code>å’Œ<code>FailApiMetric</code>ã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œéšç€æŒ‡æ ‡æ•°é‡çš„å¢å¤šï¼Œä½ ä¼šå‘ç°ä»£ç é‡Œç±»çš„å®šä¹‰ä¼šè¶Šæ¥è¶Šå¤šï¼Œä¹Ÿè¶Šæ¥è¶Šè‡ƒè‚¿ã€‚è¿™ä¹Ÿæ˜¯å•ä¾‹æ¨¡å¼æœ€å¸¸è§çš„è¯¯ç”¨åœºæ™¯ï¼Œæ›´å¥½çš„æ–¹æ³•æ˜¯å°†ä¸¤ä¸ªæŒ‡æ ‡è®¾è®¡æˆä¸€ä¸ªå¯¹è±¡<code>ApiMetric</code>ä¸‹çš„ä¸¤ä¸ªå®ä¾‹<code>ApiMetic success</code>å’Œ<code>ApiMetic fail</code>ã€‚</p>
<p><em>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦åº”è¯¥è¢«å»ºæ¨¡æˆå•ä¾‹ï¼Ÿ</em></p>
<p>é€šå¸¸ï¼Œè¢«å»ºæ¨¡æˆå•ä¾‹çš„å¯¹è±¡éƒ½æœ‰â€œ<strong>ä¸­å¿ƒç‚¹</strong>â€çš„å«ä¹‰ï¼Œæ¯”å¦‚çº¿ç¨‹æ± å°±æ˜¯ç®¡ç†æ‰€æœ‰çº¿ç¨‹çš„ä¸­å¿ƒã€‚æ‰€ä»¥ï¼Œåœ¨åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦é€‚åˆå•ä¾‹æ¨¡å¼æ—¶ï¼Œå…ˆæ€è€ƒä¸‹ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ªä¸­å¿ƒç‚¹å—ï¼Ÿ</p>
<h3 id="goå®ç°">Goå®ç°</h3>
<p>åœ¨å¯¹æŸä¸ªå¯¹è±¡å®ç°å•ä¾‹æ¨¡å¼æ—¶ï¼Œæœ‰ä¸¤ä¸ªç‚¹å¿…é¡»è¦æ³¨æ„ï¼šï¼ˆ1ï¼‰<strong>é™åˆ¶è°ƒç”¨è€…ç›´æ¥å®ä¾‹åŒ–è¯¥å¯¹è±¡</strong>ï¼›ï¼ˆ2ï¼‰<strong>ä¸ºè¯¥å¯¹è±¡çš„å•ä¾‹æä¾›ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„è®¿é—®æ–¹æ³•</strong>ã€‚</p>
<p>å¯¹äºC++/Javaè€Œè¨€ï¼Œåªéœ€æŠŠç±»çš„æ„é€ å‡½æ•°è®¾è®¡æˆç§æœ‰çš„ï¼Œå¹¶æä¾›ä¸€ä¸ª<code>static</code>æ–¹æ³•å»è®¿é—®è¯¥ç±»ç‚¹å”¯ä¸€å®ä¾‹å³å¯ã€‚ä½†å¯¹äºGoè¯­è¨€æ¥è¯´ï¼Œå³æ²¡æœ‰æ„é€ å‡½æ•°çš„æ¦‚å¿µï¼Œä¹Ÿæ²¡æœ‰<code>static</code>æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦å¦å¯»å‡ºè·¯ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Goè¯­è¨€<code>package</code>çš„è®¿é—®è§„åˆ™æ¥å®ç°ï¼Œå°†å•ä¾‹ç»“æ„ä½“è®¾è®¡æˆé¦–å­—æ¯å°å†™ï¼Œå°±èƒ½é™å®šå…¶è®¿é—®èŒƒå›´åªåœ¨å½“å‰packageä¸‹ï¼Œæ¨¡æ‹Ÿäº†C++/Javaä¸­çš„ç§æœ‰æ„é€ å‡½æ•°ï¼›å†åœ¨å½“å‰<code>package</code>ä¸‹å®ç°ä¸€ä¸ªé¦–å­—æ¯å¤§å†™çš„è®¿é—®å‡½æ•°ï¼Œå°±ç›¸å½“äº<code>static</code>æ–¹æ³•çš„ä½œç”¨äº†ã€‚</p>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°éœ€è¦é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çš„å¯¹è±¡ã€‚é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯ä¸€åˆ™æ¶ˆè€—CPUï¼ŒäºŒåˆ™å†…å­˜çš„åˆ©ç”¨ç‡ä¹Ÿä¸é«˜ï¼Œé€šå¸¸æˆ‘ä»¬éƒ½ä¼šä½¿ç”¨å¯¹è±¡æ± æŠ€æœ¯æ¥è¿›è¡Œä¼˜åŒ–ã€‚è€ƒè™‘æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡æ± ï¼Œå› ä¸ºæ˜¯å…¨å±€çš„ä¸­å¿ƒç‚¹ï¼Œç®¡ç†æ‰€æœ‰çš„Messageå®ä¾‹ï¼Œæ‰€ä»¥å°†å…¶å®ç°æˆå•ä¾‹ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package msgpool
...
// æ¶ˆæ¯æ± 
type messagePool struct {
    pool *sync.Pool
}
// æ¶ˆæ¯æ± å•ä¾‹
var msgPool = &amp;messagePool{
    // å¦‚æœæ¶ˆæ¯æ± é‡Œæ²¡æœ‰æ¶ˆæ¯ï¼Œåˆ™æ–°å»ºä¸€ä¸ªCountå€¼ä¸º0çš„Messageå®ä¾‹
    pool: &amp;sync.Pool{New: func() interface{} { return &amp;Message{Count: 0} }},
}
// è®¿é—®æ¶ˆæ¯æ± å•ä¾‹çš„å”¯ä¸€æ–¹æ³•
func Instance() *messagePool {
    return msgPool
}
// å¾€æ¶ˆæ¯æ± é‡Œæ·»åŠ æ¶ˆæ¯
func (m *messagePool) AddMsg(msg *Message) {
    m.pool.Put(msg)
}
// ä»æ¶ˆæ¯æ± é‡Œè·å–æ¶ˆæ¯
func (m *messagePool) GetMsg() *Message {
    return m.pool.Get().(*Message)
}
...
å¤åˆ¶ä»£ç 
</code></pre>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package test
...
func TestMessagePool(t *testing.T) {
    msg0 := msgpool.Instance().GetMsg()
    if msg0.Count != 0 {
        t.Errorf(&quot;expect msg count %d, but actual %d.&quot;, 0, msg0.Count)
    }
    msg0.Count = 1
    msgpool.Instance().AddMsg(msg0)
    msg1 := msgpool.Instance().GetMsg()
    if msg1.Count != 1 {
        t.Errorf(&quot;expect msg count %d, but actual %d.&quot;, 1, msg1.Count)
    }
}
// è¿è¡Œç»“æœ
=== RUN   TestMessagePool
--- PASS: TestMessagePool (0.00s)
PASS
å¤åˆ¶ä»£ç 
</code></pre>
<p>ä»¥ä¸Šçš„å•ä¾‹æ¨¡å¼å°±æ˜¯å…¸å‹çš„â€œ<strong>é¥¿æ±‰æ¨¡å¼</strong>â€ï¼Œå®ä¾‹åœ¨ç³»ç»ŸåŠ è½½çš„æ—¶å€™å°±å·²ç»å®Œæˆäº†åˆå§‹åŒ–ã€‚å¯¹åº”åœ°ï¼Œè¿˜æœ‰ä¸€ç§â€œ<strong>æ‡’æ±‰æ¨¡å¼</strong>â€ï¼Œåªæœ‰ç­‰åˆ°å¯¹è±¡è¢«ä½¿ç”¨çš„æ—¶å€™ï¼Œæ‰ä¼šå»åˆå§‹åŒ–å®ƒï¼Œä»è€Œä¸€å®šç¨‹åº¦ä¸ŠèŠ‚çœäº†å†…å­˜ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œâ€œæ‡’æ±‰æ¨¡å¼â€ä¼šå¸¦æ¥çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡<strong>æ™®é€šåŠ é”</strong>ï¼Œæˆ–è€…æ›´é«˜æ•ˆçš„<strong>åŒé‡æ£€éªŒé”</strong>æ¥ä¼˜åŒ–ã€‚å¯¹äºâ€œæ‡’æ±‰æ¨¡å¼â€ï¼ŒGoè¯­è¨€æœ‰ä¸€ä¸ªæ›´ä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œé‚£å°±æ˜¯åˆ©ç”¨<code>sync.Once</code>ï¼Œå®ƒæœ‰ä¸€ä¸ª<code>Do</code>æ–¹æ³•ï¼Œå…¶å…¥å‚æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼ŒGoè¯­è¨€ä¼šä¿è¯ä»…ä»…åªè°ƒç”¨ä¸€æ¬¡è¯¥æ–¹æ³•ã€‚</p>
<pre><code class="language-go">// å•ä¾‹æ¨¡å¼çš„â€œæ‡’æ±‰æ¨¡å¼â€å®ç°
package msgpool
...
var once = &amp;sync.Once{}
// æ¶ˆæ¯æ± å•ä¾‹ï¼Œåœ¨é¦–æ¬¡è°ƒç”¨æ—¶åˆå§‹åŒ–
var msgPool *messagePool
// å…¨å±€å”¯ä¸€è·å–æ¶ˆæ¯æ± poolåˆ°æ–¹æ³•
func Instance() *messagePool {
    // åœ¨åŒ¿åå‡½æ•°ä¸­å®ç°åˆå§‹åŒ–é€»è¾‘ï¼ŒGoè¯­è¨€ä¿è¯åªä¼šè°ƒç”¨ä¸€æ¬¡
    once.Do(func() {
        msgPool = &amp;messagePool{
            // å¦‚æœæ¶ˆæ¯æ± é‡Œæ²¡æœ‰æ¶ˆæ¯ï¼Œåˆ™æ–°å»ºä¸€ä¸ªCountå€¼ä¸º0çš„Messageå®ä¾‹
            pool: &amp;sync.Pool{New: func() interface{} { return &amp;Message{Count: 0} }},
        }
    })
    return msgPool
}
...
å¤åˆ¶ä»£ç 
</code></pre>
<h2 id="å»ºé€ è€…æ¨¡å¼builder-pattern">å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder Patternï¼‰</h2>
<figure data-type="image" tabindex="2"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghky4kprezj319e0kuu0x.jpg" alt="å»ºé€ è€…æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<h3 id="ç®€è¿°-2">ç®€è¿°</h3>
<p>åœ¨ç¨‹åºè®¾è®¡ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸é‡åˆ°ä¸€äº›å¤æ‚çš„å¯¹è±¡ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šæˆå‘˜å±æ€§ï¼Œç”šè‡³åµŒå¥—ç€å¤šä¸ªå¤æ‚çš„å¯¹è±¡ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ›å»ºè¿™ä¸ªå¤æ‚å¯¹è±¡å°±ä¼šå˜å¾—å¾ˆç¹çã€‚å¯¹äºC++/Javaè€Œè¨€ï¼Œæœ€å¸¸è§çš„è¡¨ç°å°±æ˜¯æ„é€ å‡½æ•°æœ‰ç€é•¿é•¿çš„å‚æ•°åˆ—è¡¨ï¼š</p>
<pre><code class="language-java">MyObject obj = new MyObject(param1, param2, param3, param4, param5, param6, ...)
å¤åˆ¶ä»£ç 
</code></pre>
<p>è€Œå¯¹äºGoè¯­è¨€æ¥è¯´ï¼Œæœ€å¸¸è§çš„è¡¨ç°å°±æ˜¯å¤šå±‚çš„åµŒå¥—å®ä¾‹åŒ–ï¼š</p>
<pre><code class="language-go">obj := &amp;MyObject{
  Field1: &amp;Field1 {
    Param1: &amp;Param1 {
      Val: 0,
    },
    Param2: &amp;Param2 {
      Val: 1,
    },
    ...
  },
  Field2: &amp;Field2 {
    Param3: &amp;Param3 {
      Val: 2,
    },
    ...
  },
  ...
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>ä¸Šè¿°çš„å¯¹è±¡åˆ›å»ºæ–¹æ³•æœ‰ä¸¤ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ï¼šï¼ˆ1ï¼‰<strong>å¯¹å¯¹è±¡ä½¿ç”¨è€…ä¸å‹å¥½</strong>ï¼Œä½¿ç”¨è€…åœ¨åˆ›å»ºå¯¹è±¡æ—¶éœ€è¦çŸ¥é“çš„ç»†èŠ‚å¤ªå¤šï¼›ï¼ˆ2ï¼‰<strong>ä»£ç å¯è¯»æ€§å¾ˆå·®</strong>ã€‚</p>
<p><em>é’ˆå¯¹è¿™ç§å¯¹è±¡æˆå‘˜è¾ƒå¤šï¼Œåˆ›å»ºå¯¹è±¡é€»è¾‘è¾ƒä¸ºç¹ççš„åœºæ™¯ï¼Œå°±é€‚åˆä½¿ç”¨å»ºé€ è€…æ¨¡å¼æ¥è¿›è¡Œä¼˜åŒ–ã€‚</em></p>
<p>å»ºé€ è€…æ¨¡å¼çš„ä½œç”¨æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š</p>
<p>1ã€å°è£…å¤æ‚å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œä½¿å¯¹è±¡ä½¿ç”¨è€…ä¸æ„ŸçŸ¥å¤æ‚çš„åˆ›å»ºé€»è¾‘ã€‚</p>
<p>2ã€å¯ä»¥ä¸€æ­¥æ­¥æŒ‰ç…§é¡ºåºå¯¹æˆå‘˜è¿›è¡Œèµ‹å€¼ï¼Œæˆ–è€…åˆ›å»ºåµŒå¥—å¯¹è±¡ï¼Œå¹¶æœ€ç»ˆå®Œæˆç›®æ ‡å¯¹è±¡çš„åˆ›å»ºã€‚</p>
<p>3ã€å¯¹å¤šä¸ªå¯¹è±¡å¤ç”¨åŒæ ·çš„å¯¹è±¡åˆ›å»ºé€»è¾‘ã€‚</p>
<p>å…¶ä¸­ï¼Œç¬¬1å’Œç¬¬2ç‚¹æ¯”è¾ƒå¸¸ç”¨ï¼Œä¸‹é¢å¯¹å»ºé€ è€…æ¨¡å¼çš„å®ç°ä¹Ÿä¸»è¦æ˜¯é’ˆå¯¹è¿™ä¸¤ç‚¹è¿›è¡Œç¤ºä¾‹ã€‚</p>
<h3 id="goå®ç°-2">Goå®ç°</h3>
<p>è€ƒè™‘å¦‚ä¸‹çš„ä¸€ä¸ª<code>Message</code>ç»“æ„ä½“ï¼Œå…¶ä¸»è¦æœ‰<code>Header</code>å’Œ<code>Body</code>ç»„æˆï¼š</p>
<pre><code class="language-go">package msg
...
type Message struct {
    Header *Header
    Body   *Body
}
type Header struct {
    SrcAddr  string
    SrcPort  uint64
    DestAddr string
    DestPort uint64
    Items    map[string]string
}
type Body struct {
    Items []string
}
...
å¤åˆ¶ä»£ç 
</code></pre>
<p>å¦‚æœæŒ‰ç…§ç›´æ¥çš„å¯¹è±¡åˆ›å»ºæ–¹å¼ï¼Œåˆ›å»ºé€»è¾‘åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-go">// å¤šå±‚çš„åµŒå¥—å®ä¾‹åŒ–
message := msg.Message{
    Header: &amp;msg.Header{
        SrcAddr:  &quot;192.168.0.1&quot;,
        SrcPort:  1234,
        DestAddr: &quot;192.168.0.2&quot;,
        DestPort: 8080,
        Items:    make(map[string]string),
    },
    Body:   &amp;msg.Body{
        Items: make([]string, 0),
    },
}
// éœ€è¦çŸ¥é“å¯¹è±¡çš„å®ç°ç»†èŠ‚
message.Header.Items[&quot;contents&quot;] = &quot;application/json&quot;
message.Body.Items = append(message.Body.Items, &quot;record1&quot;)
message.Body.Items = append(message.Body.Items, &quot;record2&quot;)
å¤åˆ¶ä»£ç 
</code></pre>
<p>è™½ç„¶<code>Message</code>ç»“æ„ä½“åµŒå¥—çš„å±‚æ¬¡ä¸å¤šï¼Œä½†æ˜¯ä»å…¶åˆ›å»ºçš„ä»£ç æ¥çœ‹ï¼Œç¡®å®å­˜åœ¨<strong>å¯¹å¯¹è±¡ä½¿ç”¨è€…ä¸å‹å¥½</strong>å’Œ<strong>ä»£ç å¯è¯»æ€§å·®</strong>çš„ç¼ºç‚¹ã€‚ä¸‹é¢æˆ‘ä»¬å¼•å…¥å»ºé€ è€…æ¨¡å¼å¯¹ä»£ç è¿›è¡Œé‡æ„ï¼š</p>
<pre><code class="language-go">package msg
...
// Messageå¯¹è±¡çš„Builderå¯¹è±¡
type builder struct {
    once *sync.Once
    msg *Message
}
// è¿”å›Builderå¯¹è±¡
func Builder() *builder {
    return &amp;builder{
        once: &amp;sync.Once{},
        msg: &amp;Message{Header: &amp;Header{}, Body: &amp;Body{}},
    }
}
// ä»¥ä¸‹æ˜¯å¯¹Messageæˆå‘˜å¯¹æ„å»ºæ–¹æ³•
func (b *builder) WithSrcAddr(srcAddr string) *builder {
    b.msg.Header.SrcAddr = srcAddr
    return b
}
func (b *builder) WithSrcPort(srcPort uint64) *builder {
    b.msg.Header.SrcPort = srcPort
    return b
}
func (b *builder) WithDestAddr(destAddr string) *builder {
    b.msg.Header.DestAddr = destAddr
    return b
}
func (b *builder) WithDestPort(destPort uint64) *builder {
    b.msg.Header.DestPort = destPort
    return b
}
func (b *builder) WithHeaderItem(key, value string) *builder {
  // ä¿è¯mapåªåˆå§‹åŒ–ä¸€æ¬¡
    b.once.Do(func() {
        b.msg.Header.Items = make(map[string]string)
    })
    b.msg.Header.Items[key] = value
    return b
}
func (b *builder) WithBodyItem(record string) *builder {
    b.msg.Body.Items = append(b.msg.Body.Items, record)
    return b
}
// åˆ›å»ºMessageå¯¹è±¡ï¼Œåœ¨æœ€åä¸€æ­¥è°ƒç”¨
func (b *builder) Build() *Message {
    return b.msg
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package test
...
func TestMessageBuilder(t *testing.T) {
  // ä½¿ç”¨æ¶ˆæ¯å»ºé€ è€…è¿›è¡Œå¯¹è±¡åˆ›å»º
    message := msg.Builder().
        WithSrcAddr(&quot;192.168.0.1&quot;).
        WithSrcPort(1234).
        WithDestAddr(&quot;192.168.0.2&quot;).
        WithDestPort(8080).
        WithHeaderItem(&quot;contents&quot;, &quot;application/json&quot;).
        WithBodyItem(&quot;record1&quot;).
        WithBodyItem(&quot;record2&quot;).
        Build()
    if message.Header.SrcAddr != &quot;192.168.0.1&quot; {
        t.Errorf(&quot;expect src address 192.168.0.1, but actual %s.&quot;, message.Header.SrcAddr)
    }
    if message.Body.Items[0] != &quot;record1&quot; {
        t.Errorf(&quot;expect body item0 record1, but actual %s.&quot;, message.Body.Items[0])
    }
}
// è¿è¡Œç»“æœ
=== RUN   TestMessageBuilder
--- PASS: TestMessageBuilder (0.00s)
PASS
å¤åˆ¶ä»£ç 
</code></pre>
<p>ä»æµ‹è¯•ä»£ç å¯çŸ¥ï¼Œä½¿ç”¨å»ºé€ è€…æ¨¡å¼æ¥è¿›è¡Œå¯¹è±¡åˆ›å»ºï¼Œä½¿ç”¨è€…ä¸å†éœ€è¦çŸ¥é“å¯¹è±¡å…·ä½“çš„å®ç°ç»†èŠ‚ï¼Œä»£ç å¯è¯»æ€§ä¹Ÿæ›´å¥½ã€‚</p>
<h2 id="å·¥å‚æ–¹æ³•æ¨¡å¼factory-method-pattern">å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory Method Patternï¼‰</h2>
<figure data-type="image" tabindex="3"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghkpq8hayrj31cm0sskjm.jpg" alt="å·¥å‚æ–¹æ³•æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<h3 id="ç®€è¿°-3">ç®€è¿°</h3>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼è·Ÿä¸Šä¸€èŠ‚è®¨è®ºçš„å»ºé€ è€…æ¨¡å¼ç±»ä¼¼ï¼Œéƒ½æ˜¯<strong>å°†å¯¹è±¡åˆ›å»ºçš„é€»è¾‘å°è£…èµ·æ¥ï¼Œä¸ºä½¿ç”¨è€…æä¾›ä¸€ä¸ªç®€å•æ˜“ç”¨çš„å¯¹è±¡åˆ›å»ºæ¥å£</strong>ã€‚ä¸¤è€…åœ¨åº”ç”¨åœºæ™¯ä¸Šç¨æœ‰åŒºåˆ«ï¼Œå»ºé€ è€…æ¨¡å¼æ›´å¸¸ç”¨äºéœ€è¦ä¼ é€’å¤šä¸ªå‚æ•°æ¥è¿›è¡Œå®ä¾‹åŒ–çš„åœºæ™¯ã€‚</p>
<p>ä½¿ç”¨å·¥å‚æ–¹æ³•æ¥åˆ›å»ºå¯¹è±¡ä¸»è¦æœ‰ä¸¤ä¸ªå¥½å¤„ï¼š</p>
<p>1ã€<strong>ä»£ç å¯è¯»æ€§æ›´å¥½</strong>ã€‚ç›¸æ¯”äºä½¿ç”¨C++/Javaä¸­çš„æ„é€ å‡½æ•°ï¼Œæˆ–è€…Goä¸­çš„<code>{}</code>æ¥åˆ›å»ºå¯¹è±¡ï¼Œå·¥å‚æ–¹æ³•å› ä¸ºå¯ä»¥é€šè¿‡å‡½æ•°åæ¥è¡¨è¾¾ä»£ç å«ä¹‰ï¼Œä»è€Œå…·å¤‡æ›´å¥½çš„å¯è¯»æ€§ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨å·¥å‚æ–¹æ³•<code>productA := CreateProductA()</code>åˆ›å»ºä¸€ä¸ª<code>ProductA</code>å¯¹è±¡ï¼Œæ¯”ç›´æ¥ä½¿ç”¨<code>productA := ProductA{}</code>çš„å¯è¯»æ€§è¦å¥½ã€‚</p>
<p>2ã€<strong>ä¸ä½¿ç”¨è€…ä»£ç è§£è€¦</strong>ã€‚å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå¯¹è±¡çš„åˆ›å»ºå¾€å¾€æ˜¯ä¸€ä¸ªå®¹æ˜“å˜åŒ–çš„ç‚¹ï¼Œé€šè¿‡å·¥å‚æ–¹æ³•æ¥å°è£…å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¯ä»¥åœ¨åˆ›å»ºé€»è¾‘å˜æ›´æ—¶ï¼Œé¿å…<strong>éœ°å¼¹å¼ä¿®æ”¹</strong>ã€‚</p>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼ä¹Ÿæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼šï¼ˆ1ï¼‰æä¾›ä¸€ä¸ªå·¥å‚å¯¹è±¡ï¼Œé€šè¿‡è°ƒç”¨å·¥å‚å¯¹è±¡çš„å·¥å‚æ–¹æ³•æ¥åˆ›å»ºäº§å“å¯¹è±¡ï¼›ï¼ˆ2ï¼‰å°†å·¥å‚æ–¹æ³•é›†æˆåˆ°äº§å“å¯¹è±¡ä¸­ï¼ˆC++/Javaä¸­å¯¹è±¡çš„<code>static</code>æ–¹æ³•ï¼ŒGoä¸­åŒä¸€<code>package</code>ä¸‹çš„å‡½æ•°ï¼‰</p>
<h3 id="goå®ç°-3">Goå®ç°</h3>
<p>è€ƒè™‘æœ‰ä¸€ä¸ªäº‹ä»¶å¯¹è±¡<code>Event</code>ï¼Œåˆ†åˆ«æœ‰ä¸¤ç§æœ‰æ•ˆçš„æ—¶é—´ç±»å‹<code>Start</code>å’Œ<code>End</code>ï¼š</p>
<pre><code class="language-go">package event
...
type Type uint8
// äº‹ä»¶ç±»å‹å®šä¹‰
const (
    Start Type = iota
    End
)
// äº‹ä»¶æŠ½è±¡æ¥å£
type Event interface {
    EventType() Type
    Content() string
}
// å¼€å§‹äº‹ä»¶ï¼Œå®ç°äº†Eventæ¥å£
type StartEvent struct{
    content string
}
...
// ç»“æŸäº‹ä»¶ï¼Œå®ç°äº†Eventæ¥å£
type EndEvent struct{
    content string
}
...
å¤åˆ¶ä»£ç 
</code></pre>
<p>1ã€æŒ‰ç…§ç¬¬ä¸€ç§å®ç°æ–¹å¼ï¼Œä¸º<code>Event</code>æä¾›ä¸€ä¸ªå·¥å‚å¯¹è±¡ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package event
...
// äº‹ä»¶å·¥å‚å¯¹è±¡
type Factory struct{}
// æ›´å…·äº‹ä»¶ç±»å‹åˆ›å»ºå…·ä½“äº‹ä»¶
func (e *Factory) Create(etype Type) Event {
    switch etype {
    case Start:
        return &amp;StartEvent{
            content: &quot;this is start event&quot;,
        }
    case End:
        return &amp;EndEvent{
            content: &quot;this is end event&quot;,
        }
    default:
        return nil
    }
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package test
...
func TestEventFactory(t *testing.T) {
    factory := event.Factory{}
    e := factory.Create(event.Start)
    if e.EventType() != event.Start {
        t.Errorf(&quot;expect event.Start, but actual %v.&quot;, e.EventType())
    }
    e = factory.Create(event.End)
    if e.EventType() != event.End {
        t.Errorf(&quot;expect event.End, but actual %v.&quot;, e.EventType())
    }
}
// è¿è¡Œç»“æœ
=== RUN   TestEventFactory
--- PASS: TestEventFactory (0.00s)
PASS
å¤åˆ¶ä»£ç 
</code></pre>
<p>2ã€æŒ‰ç…§ç¬¬äºŒç§å®ç°æ–¹å¼ï¼Œåˆ†åˆ«ç»™<code>Start</code>å’Œ<code>End</code>ç±»å‹çš„<code>Event</code>å•ç‹¬æä¾›ä¸€ä¸ªå·¥å‚æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package event
...
// Startç±»å‹Eventçš„å·¥å‚æ–¹æ³•
func OfStart() Event {
    return &amp;StartEvent{
        content: &quot;this is start event&quot;,
    }
}
// Endç±»å‹Eventçš„å·¥å‚æ–¹æ³•
func OfEnd() Event {
    return &amp;EndEvent{
        content: &quot;this is end event&quot;,
    }
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package event
...
func TestEvent(t *testing.T) {
    e := event.OfStart()
    if e.EventType() != event.Start {
        t.Errorf(&quot;expect event.Start, but actual %v.&quot;, e.EventType())
    }
    e = event.OfEnd()
    if e.EventType() != event.End {
        t.Errorf(&quot;expect event.End, but actual %v.&quot;, e.EventType())
    }
}
// è¿è¡Œç»“æœ
=== RUN   TestEvent
--- PASS: TestEvent (0.00s)
PASS
å¤åˆ¶ä»£ç 
</code></pre>
<h2 id="æŠ½è±¡å·¥å‚æ¨¡å¼abstract-factory-pattern">æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract Factory Patternï¼‰</h2>
<figure data-type="image" tabindex="4"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghkxo5tf5ij31ak0om4qq.jpg" alt="æŠ½è±¡å·¥å‚æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<h3 id="ç®€è¿°-4">ç®€è¿°</h3>
<p>åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå·¥å‚å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªäº§å“æ—ï¼Œå…·ä½“åˆ›å»ºå“ªä¸ªäº§å“ï¼Œåˆ™é€šè¿‡<code>swtich-case</code>çš„æ–¹å¼å»åˆ¤æ–­ã€‚è¿™ä¹Ÿæ„å‘³ç€è¯¥äº§å“ç»„ä¸Šï¼Œæ¯æ–°å¢ä¸€ç±»äº§å“å¯¹è±¡ï¼Œéƒ½å¿…é¡»ä¿®æ”¹åŸæ¥å·¥å‚å¯¹è±¡çš„ä»£ç ï¼›è€Œä¸”éšç€äº§å“çš„ä¸æ–­å¢å¤šï¼Œå·¥å‚å¯¹è±¡çš„èŒè´£ä¹Ÿè¶Šæ¥è¶Šé‡ï¼Œè¿åäº†<strong>å•ä¸€èŒè´£åŸåˆ™</strong>ã€‚</p>
<p>æŠ½è±¡å·¥å‚æ¨¡å¼é€šè¿‡ç»™å·¥å‚ç±»æ–°å¢ä¸€ä¸ªæŠ½è±¡å±‚è§£å†³äº†è¯¥é—®é¢˜ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ<code>FactoryA</code>å’Œ<code>FactoryB</code>éƒ½å®ç°Â·æŠ½è±¡å·¥å‚æ¥å£ï¼Œåˆ†åˆ«ç”¨äºåˆ›å»º<code>ProductA</code>å’Œ<code>ProductB</code>ã€‚å¦‚æœåç»­æ–°å¢äº†<code>ProductC</code>ï¼Œåªéœ€æ–°å¢ä¸€ä¸ª<code>FactoryC</code>å³å¯ï¼Œæ— éœ€ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼›å› ä¸ºæ¯ä¸ªå·¥å‚åªè´Ÿè´£åˆ›å»ºä¸€ä¸ªäº§å“ï¼Œå› æ­¤ä¹Ÿéµå¾ªäº†<strong>å•ä¸€èŒè´£åŸåˆ™</strong>ã€‚</p>
<h3 id="goå®ç°-4">Goå®ç°</h3>
<p>è€ƒè™‘éœ€è¦å¦‚ä¸‹ä¸€ä¸ªæ’ä»¶æ¶æ„é£æ ¼çš„æ¶ˆæ¯å¤„ç†ç³»ç»Ÿï¼Œ<code>pipeline</code>æ˜¯æ¶ˆæ¯å¤„ç†çš„ç®¡é“ï¼Œå…¶ä¸­åŒ…å«äº†<code>input</code>ã€<code>filter</code>å’Œ<code>output</code>ä¸‰ä¸ªæ’ä»¶ã€‚æˆ‘ä»¬éœ€è¦å®ç°æ ¹æ®é…ç½®æ¥åˆ›å»º<code>pipeline</code> ï¼ŒåŠ è½½æ’ä»¶è¿‡ç¨‹çš„å®ç°éå¸¸é€‚åˆä½¿ç”¨å·¥å‚æ¨¡å¼ï¼Œå…¶ä¸­<code>input</code>ã€<code>filter</code>å’Œ<code>output</code>ä¸‰ç±»æ’ä»¶çš„åˆ›å»ºä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œè€Œ<code>pipeline</code>çš„åˆ›å»ºåˆ™ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼ã€‚</p>
<figure data-type="image" tabindex="5"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghkw23e4r3j31bs0nge82.jpg" alt="æŠ½è±¡å·¥å‚æ¨¡å¼ç¤ºä¾‹" loading="lazy"></figure>
<p>å„ç±»æ’ä»¶å’Œ<code>pipeline</code>çš„æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package plugin
...
// æ’ä»¶æŠ½è±¡æ¥å£å®šä¹‰
type Plugin interface {}
// è¾“å…¥æ’ä»¶ï¼Œç”¨äºæ¥æ”¶æ¶ˆæ¯
type Input interface {
    Plugin
    Receive() string
}
// è¿‡æ»¤æ’ä»¶ï¼Œç”¨äºå¤„ç†æ¶ˆæ¯
type Filter interface {
    Plugin
    Process(msg string) string
}
// è¾“å‡ºæ’ä»¶ï¼Œç”¨äºå‘é€æ¶ˆæ¯
type Output interface {
    Plugin
    Send(msg string)
}
å¤åˆ¶ä»£ç 
package pipeline
...
// æ¶ˆæ¯ç®¡é“çš„å®šä¹‰
type Pipeline struct {
    input  plugin.Input
    filter plugin.Filter
    output plugin.Output
}
// ä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†æµç¨‹ä¸º input -&gt; filter -&gt; output
func (p *Pipeline) Exec() {
    msg := p.input.Receive()
    msg = p.filter.Process(msg)
    p.output.Send(msg)
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>æ¥ç€ï¼Œæˆ‘ä»¬å®šä¹‰<code>input</code>ã€<code>filter</code>ã€<code>output</code>ä¸‰ç±»æ’ä»¶æ¥å£çš„å…·ä½“å®ç°ï¼š</p>
<pre><code class="language-go">package plugin
...
// inputæ’ä»¶åç§°ä¸ç±»å‹çš„æ˜ å°„å…³ç³»ï¼Œä¸»è¦ç”¨äºé€šè¿‡åå°„åˆ›å»ºinputå¯¹è±¡
var inputNames = make(map[string]reflect.Type)
// Hello inputæ’ä»¶ï¼Œæ¥æ”¶â€œHello Worldâ€æ¶ˆæ¯
type HelloInput struct {}

func (h *HelloInput) Receive() string {
    return &quot;Hello World&quot;
}
// åˆå§‹åŒ–inputæ’ä»¶æ˜ å°„å…³ç³»è¡¨
func init() {
    inputNames[&quot;hello&quot;] = reflect.TypeOf(HelloInput{})
}
å¤åˆ¶ä»£ç 
package plugin
...
// filteræ’ä»¶åç§°ä¸ç±»å‹çš„æ˜ å°„å…³ç³»ï¼Œä¸»è¦ç”¨äºé€šè¿‡åå°„åˆ›å»ºfilterå¯¹è±¡
var filterNames = make(map[string]reflect.Type)
// Upper filteræ’ä»¶ï¼Œå°†æ¶ˆæ¯å…¨éƒ¨å­—æ¯è½¬æˆå¤§å†™
type UpperFilter struct {}

func (u *UpperFilter) Process(msg string) string {
    return strings.ToUpper(msg)
}
// åˆå§‹åŒ–filteræ’ä»¶æ˜ å°„å…³ç³»è¡¨
func init() {
    filterNames[&quot;upper&quot;] = reflect.TypeOf(UpperFilter{})
}
å¤åˆ¶ä»£ç 
package plugin
...
// outputæ’ä»¶åç§°ä¸ç±»å‹çš„æ˜ å°„å…³ç³»ï¼Œä¸»è¦ç”¨äºé€šè¿‡åå°„åˆ›å»ºoutputå¯¹è±¡
var outputNames = make(map[string]reflect.Type)
// Console outputæ’ä»¶ï¼Œå°†æ¶ˆæ¯è¾“å‡ºåˆ°æ§åˆ¶å°ä¸Š
type ConsoleOutput struct {}

func (c *ConsoleOutput) Send(msg string) {
    fmt.Println(msg)
}
// åˆå§‹åŒ–outputæ’ä»¶æ˜ å°„å…³ç³»è¡¨
func init() {
    outputNames[&quot;console&quot;] = reflect.TypeOf(ConsoleOutput{})
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰æ’ä»¶æŠ½è±¡å·¥å‚æ¥å£ï¼Œä»¥åŠå¯¹åº”æ’ä»¶çš„å·¥å‚å®ç°ï¼š</p>
<pre><code class="language-go">package plugin
...
// æ’ä»¶æŠ½è±¡å·¥å‚æ¥å£
type Factory interface {
    Create(conf Config) Plugin
}
// inputæ’ä»¶å·¥å‚å¯¹è±¡ï¼Œå®ç°Factoryæ¥å£
type InputFactory struct{}
// è¯»å–é…ç½®ï¼Œé€šè¿‡åå°„æœºåˆ¶è¿›è¡Œå¯¹è±¡å®ä¾‹åŒ–
func (i *InputFactory) Create(conf Config) Plugin {
    t, _ := inputNames[conf.Name]
    return reflect.New(t).Interface().(Plugin)
}
// filterå’Œoutputæ’ä»¶å·¥å‚å®ç°ç±»ä¼¼
type FilterFactory struct{}
func (f *FilterFactory) Create(conf Config) Plugin {
    t, _ := filterNames[conf.Name]
    return reflect.New(t).Interface().(Plugin)
}
type OutputFactory struct{}
func (o *OutputFactory) Create(conf Config) Plugin {
    t, _ := outputNames[conf.Name]
    return reflect.New(t).Interface().(Plugin)
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>æœ€åå®šä¹‰<code>pipeline</code>çš„å·¥å‚æ–¹æ³•ï¼Œè°ƒç”¨<code>plugin.Factory</code>æŠ½è±¡å·¥å‚å®Œæˆpipelienå¯¹è±¡çš„å®ä¾‹åŒ–ï¼š</p>
<pre><code class="language-go">package pipeline
...
// ä¿å­˜ç”¨äºåˆ›å»ºPluginçš„å·¥å‚å®ä¾‹ï¼Œå…¶ä¸­mapçš„keyä¸ºæ’ä»¶ç±»å‹ï¼Œvalueä¸ºæŠ½è±¡å·¥å‚æ¥å£
var pluginFactories = make(map[plugin.Type]plugin.Factory)
// æ ¹æ®plugin.Typeè¿”å›å¯¹åº”Pluginç±»å‹çš„å·¥å‚å®ä¾‹
func factoryOf(t plugin.Type) plugin.Factory {
    factory, _ := pluginFactories[t]
    return factory
}
// pipelineå·¥å‚æ–¹æ³•ï¼Œæ ¹æ®é…ç½®åˆ›å»ºä¸€ä¸ªPipelineå®ä¾‹
func Of(conf Config) *Pipeline {
    p := &amp;Pipeline{}
    p.input = factoryOf(plugin.InputType).Create(conf.Input).(plugin.Input)
    p.filter = factoryOf(plugin.FilterType).Create(conf.Filter).(plugin.Filter)
    p.output = factoryOf(plugin.OutputType).Create(conf.Output).(plugin.Output)
    return p
}
// åˆå§‹åŒ–æ’ä»¶å·¥å‚å¯¹è±¡
func init() {
    pluginFactories[plugin.InputType] = &amp;plugin.InputFactory{}
    pluginFactories[plugin.FilterType] = &amp;plugin.FilterFactory{}
    pluginFactories[plugin.OutputType] = &amp;plugin.OutputFactory{}
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package test
...
func TestPipeline(t *testing.T) {
  // å…¶ä¸­pipeline.DefaultConfig()çš„é…ç½®å†…å®¹è§ã€æŠ½è±¡å·¥å‚æ¨¡å¼ç¤ºä¾‹å›¾ã€‘
  // æ¶ˆæ¯å¤„ç†æµç¨‹ä¸º HelloInput -&gt; UpperFilter -&gt; ConsoleOutput
    p := pipeline.Of(pipeline.DefaultConfig())
    p.Exec()
}
// è¿è¡Œç»“æœ
=== RUN   TestPipeline
HELLO WORLD
--- PASS: TestPipeline (0.00s)
PASS
å¤åˆ¶ä»£ç 
</code></pre>
<h2 id="åŸå‹æ¨¡å¼prototype-pattern">åŸå‹æ¨¡å¼ï¼ˆPrototype Patternï¼‰</h2>
<figure data-type="image" tabindex="6"><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ghky39ichjj319u0gqhdt.jpg" alt="åŸå‹æ¨¡å¼ç»“æ„" loading="lazy"></figure>
<h3 id="ç®€è¿°-5">ç®€è¿°</h3>
<p>åŸå‹æ¨¡å¼ä¸»è¦è§£å†³å¯¹è±¡å¤åˆ¶çš„é—®é¢˜ï¼Œå®ƒçš„æ ¸å¿ƒå°±æ˜¯<code>clone()</code>æ–¹æ³•ï¼Œè¿”å›<code>Prototype</code>å¯¹è±¡çš„å¤åˆ¶å“ã€‚åœ¨ç¨‹åºè®¾è®¡è¿‡ç¨‹ä¸­ï¼Œå¾€å¾€ä¼šé‡åˆ°æœ‰ä¸€äº›åœºæ™¯éœ€è¦å¤§é‡ç›¸åŒçš„å¯¹è±¡ï¼Œå¦‚æœä¸ä½¿ç”¨åŸå‹æ¨¡å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯èƒ½ä¼šè¿™æ ·è¿›è¡Œå¯¹è±¡çš„åˆ›å»ºï¼š<em>æ–°åˆ›å»ºä¸€ä¸ªç›¸åŒå¯¹è±¡çš„å®ä¾‹ï¼Œç„¶åéå†åŸå§‹å¯¹è±¡çš„æ‰€æœ‰æˆå‘˜å˜é‡ï¼Œ å¹¶å°†æˆå‘˜å˜é‡å€¼å¤åˆ¶åˆ°æ–°å¯¹è±¡ä¸­</em>ã€‚è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œé‚£å°±æ˜¯ä½¿ç”¨è€…å¿…é¡»çŸ¥é“å¯¹è±¡çš„å®ç°ç»†èŠ‚ï¼Œå¯¼è‡´ä»£ç ä¹‹é—´çš„è€¦åˆã€‚å¦å¤–ï¼Œå¯¹è±¡å¾ˆæœ‰å¯èƒ½å­˜åœ¨é™¤äº†å¯¹è±¡æœ¬èº«ä»¥å¤–ä¸å¯è§çš„å˜é‡ï¼Œè¿™ç§æƒ…å†µä¸‹è¯¥æ–¹æ³•å°±è¡Œä¸é€šäº†ã€‚</p>
<p>å¯¹äºè¿™ç§æƒ…å†µï¼Œæ›´å¥½çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨åŸå‹æ¨¡å¼ï¼Œå°†å¤åˆ¶é€»è¾‘å§”æ‰˜ç»™å¯¹è±¡æœ¬èº«ï¼Œè¿™æ ·ï¼Œä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ä¹Ÿéƒ½è¿åˆƒè€Œè§£äº†ã€‚</p>
<h3 id="goå®ç°-5">Goå®ç°</h3>
<p>è¿˜æ˜¯ä»¥å»ºé€ è€…æ¨¡å¼ä¸€èŠ‚ä¸­çš„<code>Message</code>ä½œä¸ºä¾‹å­ï¼Œç°åœ¨è®¾è®¡ä¸€ä¸ª<code>Prototype</code>æŠ½è±¡æ¥å£ï¼š</p>
<pre><code class="language-go">package prototype
...
// åŸå‹å¤åˆ¶æŠ½è±¡æ¥å£
type Prototype interface {
    clone() Prototype
}

type Message struct {
    Header *Header
    Body   *Body
}

func (m *Message) clone() Prototype {
    msg := *m
    return &amp;msg
}
å¤åˆ¶ä»£ç 
</code></pre>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">package test
...
func TestPrototype(t *testing.T) {
    message := msg.Builder().
        WithSrcAddr(&quot;192.168.0.1&quot;).
        WithSrcPort(1234).
        WithDestAddr(&quot;192.168.0.2&quot;).
        WithDestPort(8080).
        WithHeaderItem(&quot;contents&quot;, &quot;application/json&quot;).
        WithBodyItem(&quot;record1&quot;).
        WithBodyItem(&quot;record2&quot;).
        Build()
  // å¤åˆ¶ä¸€ä»½æ¶ˆæ¯
    newMessage := message.Clone().(*msg.Message)
    if newMessage.Header.SrcAddr != message.Header.SrcAddr {
        t.Errorf(&quot;Clone Message failed.&quot;)
    }
    if newMessage.Body.Items[0] != message.Body.Items[0] {
        t.Errorf(&quot;Clone Message failed.&quot;)
    }
}
// è¿è¡Œç»“æœ
=== RUN   TestPrototype
--- PASS: TestPrototype (0.00s)
PASS
å¤åˆ¶ä»£ç 
</code></pre>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº†GoFçš„23ç§è®¾è®¡æ¨¡å¼ä¸­çš„5ç§åˆ›å»ºå‹æ¨¡å¼ï¼Œåˆ›å»ºå‹æ¨¡å¼çš„ç›®çš„éƒ½æ˜¯<strong>æä¾›ä¸€ä¸ªç®€å•çš„æ¥å£ï¼Œè®©å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ä¸ä½¿ç”¨è€…è§£è€¦</strong>ã€‚å…¶ä¸­ï¼Œ<strong>å•ä¾‹æ¨¡å¼</strong>ä¸»è¦ç”¨äºä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ï¼›<strong>å»ºé€ è€…æ¨¡å¼</strong>ä¸»è¦è§£å†³éœ€è¦åˆ›å»ºå¯¹è±¡æ—¶éœ€è¦ä¼ å…¥å¤šä¸ªå‚æ•°ï¼Œæˆ–è€…å¯¹åˆå§‹åŒ–é¡ºåºæœ‰è¦æ±‚çš„åœºæ™¯ï¼›<strong>å·¥å‚æ–¹æ³•æ¨¡å¼</strong>é€šè¿‡æä¾›ä¸€ä¸ªå·¥å‚å¯¹è±¡æˆ–è€…å·¥å‚æ–¹æ³•ï¼Œä¸ºä½¿ç”¨è€…éšè—äº†å¯¹è±¡åˆ›å»ºçš„ç»†èŠ‚ï¼›<strong>æŠ½è±¡å·¥å‚æ¨¡å¼</strong>æ˜¯å¯¹å·¥å‚æ–¹æ³•æ¨¡å¼çš„ä¼˜åŒ–ï¼Œé€šè¿‡ä¸ºå·¥å‚å¯¹è±¡æ–°å¢ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œè®©å·¥å‚å¯¹è±¡éµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œä¹Ÿé¿å…äº†éœ°å¼¹å¼ä¿®æ”¹ï¼›<strong>åŸå‹æ¨¡å¼</strong>åˆ™è®©å¯¹è±¡å¤åˆ¶æ›´åŠ ç®€å•ã€‚</p>
<p>ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œå°†ä»‹ç»23ç§è®¾è®¡æ¨¡å¼ä¸­çš„7ç§<strong>ç»“æ„å‹æ¨¡å¼</strong>ï¼ˆStructural Patternï¼‰ï¼ŒåŠå…¶Goè¯­è¨€çš„å®ç°ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ç”¨ golang å®ç°çš„åå¤§ç»å…¸æ’åº]]></title>
        <id>https://ChicRingo.github.io/post/yong-golang-shi-xian-de-shi-da-jing-dian-pai-xu/</id>
        <link href="https://ChicRingo.github.io/post/yong-golang-shi-xian-de-shi-da-jing-dian-pai-xu/">
        </link>
        <updated>2020-08-28T05:06:03.000Z</updated>
        <summary type="html"><![CDATA[<p>ç”¨goè¯­è¨€å®ç°çš„åå¤§ç»å…¸æ’åº</p>
]]></summary>
        <content type="html"><![CDATA[<p>ç”¨goè¯­è¨€å®ç°çš„åå¤§ç»å…¸æ’åº</p>
<!-- more -->
<h3 id="å†’æ³¡æ’åº">å†’æ³¡æ’åº</h3>
<pre><code class="language-go">// å†’æ³¡æ’åº
func bubble(nums []int) []int {
   numLen := len(nums)

   for i := 0; i &lt; numLen; i++ {
      // æŒ‰ç›¸é‚»ä¸¤ä¸ªä¸€èµ·æ¯”è¾ƒï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªä¸ç”¨éå† -1,å·²ç»æ’åºçš„ä¹Ÿä¸ç”¨é‡æ–°æ’åºï¼Œæ‰€ä»¥-iï¼Œä¸å†™ä¹Ÿå¯
      for j := 0; j &lt; numLen-1-i; j++ {
         // å½“å‰å€¼å¤§äºåä¸€ä¸ªå€¼ï¼Œåˆ™å¯¹æ¢ä½ç½®
         if nums[j] &gt; nums[j+1] {
            nums[j], nums[j+1] = nums[j+1], nums[j]
         }
      }
   }

   return nums
}
</code></pre>
<h3 id="é€‰æ‹©æ’åº">é€‰æ‹©æ’åº</h3>
<pre><code class="language-go">func selection(nums []int) []int {
   numLen := len(nums)
   //æœ€åä¸€ä¸ªä¸ç”¨æ’åºäº†
   for i := 0; i &lt; numLen-1; i++ {
      //æ¯æ¬¡æœ€å°å€¼çš„ä½ç½®index
      var minIndex = i
      // ä»ç¬¬äºŒä¸ªå¼€å§‹æ’åºï¼Œä¹Ÿå°±æ˜¯i+1
      for j := i + 1; j &lt; numLen; j++ {
         if nums[j] &lt; nums[minIndex] {
            minIndex = j
         }
      }
      nums[i], nums[minIndex] = nums[minIndex], nums[i]
   }

   return nums
}
</code></pre>
<h3 id="æ’å…¥æ’åº">æ’å…¥æ’åº</h3>
<pre><code class="language-go">func insertion(nums []int) []int {
   // ç½‘ä¸Šå†™æ³•
   for i, tmp := range nums {
      // å‰ä¸€ä¸ªç´¢å¼•å€¼
      preIndex := i - 1
      // å®šä¹‰ä¸€ä¸ªä¸´æ—¶å˜é‡å–å½“å‰çš„å€¼ï¼ˆæŒ–å‡ºæ¥è…¾åœ°æ–¹ï¼Œç»™å‰é¢çš„å¾€åæŒªä½ç½®çš„ç©ºé—´
      //tmp := nums[i]
      // å¦‚æœå½“å‰å€¼ tmp å°äºå‰é¢çš„å€¼ï¼Œå°±æŠŠå‰é¢çš„å€¼å¾€åæŒªï¼Œå› ä¸ºtmpå·²ç»ä¿å­˜è¿‡ç›¸å½“äºç©ºçš„
      for preIndex &gt;= 0 &amp;&amp; tmp &lt; nums[preIndex] {
         nums[preIndex+1] = nums[preIndex]
         preIndex--
      }
      // ä¸æ»¡è¶³ä»¥ä¸Šæ¡ä»¶æ—¶ï¼Œè¯´æ˜æ²¡æœ‰æ¯”tmpæ›´å°çš„ï¼Œå°±ä¿å­˜tmpå½“å‰å€¼åˆ°æ–°çš„ä½ç½®
      nums[preIndex+1] = tmp
   }

   // è‡ªå·±å†™æ³•
   //numLen := len(nums)
   //for i := 1; i &lt; numLen; i++ { //ä»ç¬¬2ä¸ªå¼€å§‹ï¼Œi=1å¼€å§‹
   //
   // temp := nums[i] // å®šä¹‰ä¸€ä¸ªä¸´æ—¶å˜é‡å–å½“å‰çš„å€¼
   // // æŠŠè¯¥å€¼tmpä¸ä¹‹å‰çš„æ•° ä»åå¾€å‰è¿›è¡Œæ¯”è¾ƒ
   // for j := i - 1; j &gt;= 0; j-- {
   //    // å½“ å½“å‰å€¼tmp æ¯”ä¹‹å‰çš„æŸä¸ªå€¼å¤§,é‚£ä¹ˆæ’å…¥,å¦åˆ™æŠŠæ¯ä¸ªå€¼å¾€åç§»ä¸€ä½
   //    if temp &gt; nums[j] {
   //       nums[j+1] = temp
   //       break
   //    } else {
   //       nums[j+1] = nums[j]
   //    }
   //    // å¦‚æœéƒ½ç§»åŠ¨äº†,ç„¶åéå†åˆ°0äº†,è¯´æ˜å½“å‰å€¼æ˜¯æœ€å°çš„,æŠŠå½“å‰å€¼æ”¾åˆ°æœ€å°çš„ä½ç½®
   //    if j == 0 {
   //       nums[0] = temp
   //    }
   // }
   //}
   return nums
}
</code></pre>
<h3 id="å¸Œå°”æ’åº">å¸Œå°”æ’åº</h3>
<h3 id="å½’å¹¶æ’åº">å½’å¹¶æ’åº</h3>
<h3 id="å¿«é€Ÿæ’åº">å¿«é€Ÿæ’åº</h3>
<pre><code class="language-go">func partition(nums []int, left, right int) int {
   // è®¾åŸºå‡†å€¼ privot ä¸ºleft
   privot := left
   index := privot + 1
   for i := index; i &lt;= right; i++ {
      if nums[i] &lt; nums[privot] {
         nums[i], nums[index] = nums[index], nums[i]
         index++
      }
   }
   nums[privot], nums[index-1] = nums[index-1], nums[privot]
   return index - 1
}

func quickSort(nums []int, left, right int) {
   // å¦‚æœæ•°ç»„é•¿åº¦å°äºç­‰äº1ï¼Œè¯´æ˜è¿™ä¸ªæ•°ç»„åˆ†åŒºä¸éœ€è¦å†æ’åºäº†ï¼Œç›´æ¥return
   if len(nums) &lt;= 1 {
      return
   }
   // å¦‚æœå·¦å°äºå³ï¼Œ
   if left &lt; right {
      partIndex := partition(nums, left, right)
      quickSort(nums, left, partIndex-1)
      quickSort(nums, partIndex+1, right)
   }
   return
}
</code></pre>
<h3 id="å †æ’åº">å †æ’åº</h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[æˆ‘æ“¦~å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡åï¼Œåˆ‡ç‰‡çš„å®¹é‡ç«Ÿç„¶åƒå¥‡ç™¾æ€ª]]></title>
        <id>https://ChicRingo.github.io/post/wo-ca-~zi-fu-chuan-zhuan-zi-jie-qie-pian-hou-qie-pian-de-rong-liang-jing-ran-qian-qi-bai-guai/</id>
        <link href="https://ChicRingo.github.io/post/wo-ca-~zi-fu-chuan-zhuan-zi-jie-qie-pian-hou-qie-pian-de-rong-liang-jing-ran-qian-qi-bai-guai/">
        </link>
        <updated>2020-08-25T00:56:36.000Z</updated>
        <summary type="html"><![CDATA[<p>å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æ­¥éª¤å¦‚ä¸‹</p>
<ol>
<li>
<p>åˆ¤æ–­æ˜¯å¦æ˜¯å¸¸é‡ï¼Œ å¦‚æœæ˜¯å¸¸é‡åˆ™è½¬æ¢ä¸ºç­‰å®¹é‡ç­‰é•¿çš„å­—èŠ‚åˆ‡ç‰‡</p>
</li>
<li>
<p>å¦‚æœæ˜¯å˜é‡ï¼Œ å…ˆåˆ¤æ–­ç”Ÿæˆçš„åˆ‡ç‰‡æ˜¯å¦å‘ç”Ÿå˜é‡é€ƒé€¸</p>
</li>
<li>
<ul>
<li>å¦‚æœé€ƒé€¸æˆ–è€…å­—ç¬¦ä¸²é•¿åº¦&gt;32ï¼Œ åˆ™æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦å¯ä»¥è®¡ç®—å‡ºä¸åŒçš„å®¹é‡</li>
<li>å¦‚æœæœªé€ƒé€¸ä¸”å­—ç¬¦ä¸²é•¿åº¦&lt;=32, åˆ™å­—ç¬¦åˆ‡ç‰‡å®¹é‡ä¸º32</li>
</ul>
</li>
</ol>
]]></summary>
        <content type="html"><![CDATA[<p>å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æ­¥éª¤å¦‚ä¸‹</p>
<ol>
<li>
<p>åˆ¤æ–­æ˜¯å¦æ˜¯å¸¸é‡ï¼Œ å¦‚æœæ˜¯å¸¸é‡åˆ™è½¬æ¢ä¸ºç­‰å®¹é‡ç­‰é•¿çš„å­—èŠ‚åˆ‡ç‰‡</p>
</li>
<li>
<p>å¦‚æœæ˜¯å˜é‡ï¼Œ å…ˆåˆ¤æ–­ç”Ÿæˆçš„åˆ‡ç‰‡æ˜¯å¦å‘ç”Ÿå˜é‡é€ƒé€¸</p>
</li>
<li>
<ul>
<li>å¦‚æœé€ƒé€¸æˆ–è€…å­—ç¬¦ä¸²é•¿åº¦&gt;32ï¼Œ åˆ™æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦å¯ä»¥è®¡ç®—å‡ºä¸åŒçš„å®¹é‡</li>
<li>å¦‚æœæœªé€ƒé€¸ä¸”å­—ç¬¦ä¸²é•¿åº¦&lt;=32, åˆ™å­—ç¬¦åˆ‡ç‰‡å®¹é‡ä¸º32</li>
</ul>
</li>
</ol>
<!-- more -->
<p>ä»¥ä¸‹æ–‡ç« æ¥æºäºæ–°ä¸–ç•Œæ‚è´§é“º ï¼Œä½œè€…è®¸æ–‡</p>
<p><a href="https://baijiahao.baidu.com/s?id=1671902920320901161"><strong>æ–°ä¸–ç•Œæ‚è´§é“º</strong>ä½œä¸ºä¸€åGopherï¼Œ æˆ‘æ„¿ç§°ä¹‹ä¸ºGoçš„å¹²(æ‚)è´§é“ºå­ï¼</a></p>
<p>ç¥å¥‡çš„ç°è±¡</p>
<p>åˆ‡ç‰‡ï¼Œ åˆ‡ç‰‡ï¼Œ åˆæ˜¯åˆ‡ç‰‡!</p>
<p>ä»Šå¤©é‡åˆ°çš„ç¥å¥‡é—®é¢˜å’Œåˆ‡ç‰‡æœ‰å…³ï¼Œ å…·ä½“æ€ä¹ˆä¸ªç¥å¥‡æ³•ï¼Œ æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢å‡ ä¸ªç°è±¡</p>
<h3 id="ç°è±¡ä¸€">ç°è±¡ä¸€</h3>
<pre><code>a := &quot;abc&quot;
bs := []byte(a)
fmt.Println(bs, len(bs), cap(bs))
// è¾“å‡ºï¼š [97 98 99] 3 8
</code></pre>
<h3 id="ç°è±¡äºŒ">ç°è±¡äºŒ</h3>
<pre><code>a := &quot;abc&quot;
bs := []byte(a)
fmt.Println(len(bs), cap(bs))
// è¾“å‡º: 3 32
</code></pre>
<h3 id="ç°è±¡ä¸‰">ç°è±¡ä¸‰</h3>
<pre><code>bs := []byte(&quot;abc&quot;)
fmt.Println(len(bs), cap(bs))
// è¾“å‡º: 3 3
</code></pre>
<h3 id="ç°è±¡å››">ç°è±¡å››</h3>
<pre><code>a := &quot;&quot;
bs := []byte(a)
fmt.Println(bs, len(bs), cap(bs))
// è¾“å‡º: [] 0 0
</code></pre>
<h3 id="ç°è±¡äº”">ç°è±¡äº”</h3>
<pre><code>a := &quot;&quot;
bs := []byte(a)
fmt.Println(len(bs), cap(bs))
// è¾“å‡º: 0 32
</code></pre>
<h2 id="åˆ†æ">åˆ†æ</h2>
<p>åˆ°è¿™å„¿æˆ‘å·²ç»æ»¡è„‘å­é—®å·äº†</p>
<figure data-type="image" tabindex="1"><img src="https://pics4.baidu.com/feed/b7003af33a87e95024fc161f982aa645faf2b4f7.jpeg?token=851a11b97e2f5c17586d5100942c414e" alt="img" loading="lazy"></figure>
<h3 id="å­—ç¬¦ä¸²å˜é‡è½¬åˆ‡ç‰‡">å­—ç¬¦ä¸²å˜é‡è½¬åˆ‡ç‰‡</h3>
<p>ä¸€ä¸ªå°å°çš„å­—ç¬¦ä¸²è½¬åˆ‡ç‰‡ï¼Œ å†…éƒ¨ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Œ ç«Ÿç„¶å¦‚æ­¤çš„ç¥å¥‡ã€‚è¿™ç§æ—¶å€™åªå¥½ç¥­å‡ºæ±‡ç¼–å¤§æ³•ï¼Œ çœ‹çœ‹æ±‡ç¼–ä»£ç (<code>å¸Œæœ›ä¹‹åæœ‰æœºä¼šèƒ½å¤Ÿå¯¹goçš„æ±‡ç¼–è¯­æ³•è¿›è¡Œç®€å•çš„ä»‹ç»</code>)æœ‰æ²¡æœ‰ä»€ä¹ˆå…³é”®è¯èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬</p>
<p>ä»¥ä¸‹ä¸ºç°è±¡ä¸€è½¬æ¢çš„æ±‡ç¼–ä»£ç å…³é”®éƒ¨åˆ†</p>
<pre><code>&quot;&quot;.main STEXT size=495 args=0x0 locals=0xd8
	0x0000 00000 (test.go:5)	TEXT	&quot;&quot;.main(SB), ABIInternal, $216-0
	0x0000 00000 (test.go:5)	MOVQ	(TLS), CX
	0x0009 00009 (test.go:5)	LEAQ	-88(SP), AX
	0x000e 00014 (test.go:5)	CMPQ	AX, 16(CX)
	0x0012 00018 (test.go:5)	JLS	485
	0x0018 00024 (test.go:5)	SUBQ	$216, SP
	0x001f 00031 (test.go:5)	MOVQ	BP, 208(SP)
	0x0027 00039 (test.go:5)	LEAQ	208(SP), BP
	0x002f 00047 (test.go:5)	FUNCDATA	$0, gclocalsÂ·7be4bbacbfdb05fb3044e36c22b41e8b(SB)
	0x002f 00047 (test.go:5)	FUNCDATA	$1, gclocalsÂ·648d0b72bb9d7f59fbfdbee57a078eee(SB)
	0x002f 00047 (test.go:5)	FUNCDATA	$2, gclocalsÂ·2dfddcc7190380b1ae77e69d81f0a101(SB)
	0x002f 00047 (test.go:5)	FUNCDATA	$3, &quot;&quot;.main.stkobj(SB)
	0x002f 00047 (test.go:6)	PCDATA	$0, $1
	0x002f 00047 (test.go:6)	PCDATA	$1, $0
	0x002f 00047 (test.go:6)	LEAQ	go.string.&quot;abc&quot;(SB), AX
	0x0036 00054 (test.go:6)	MOVQ	AX, &quot;&quot;.a+96(SP)
	0x003b 00059 (test.go:6)	MOVQ	$3, &quot;&quot;.a+104(SP)
	0x0044 00068 (test.go:7)	MOVQ	$0, (SP)
	0x004c 00076 (test.go:7)	PCDATA	$0, $0
	0x004c 00076 (test.go:7)	MOVQ	AX, 8(SP)
	0x0051 00081 (test.go:7)	MOVQ	$3, 16(SP)
	0x005a 00090 (test.go:7)	CALL	runtime.stringtoslicebyte(SB)
	0x005f 00095 (test.go:7)	MOVQ	40(SP), AX
	0x0064 00100 (test.go:7)	MOVQ	32(SP), CX
	0x0069 00105 (test.go:7)	PCDATA	$0, $2
	0x0069 00105 (test.go:7)	MOVQ	24(SP), DX
	0x006e 00110 (test.go:7)	PCDATA	$0, $0
	0x006e 00110 (test.go:7)	PCDATA	$1, $1
	0x006e 00110 (test.go:7)	MOVQ	DX, &quot;&quot;.bs+112(SP)
	0x0073 00115 (test.go:7)	MOVQ	CX, &quot;&quot;.bs+120(SP)
	0x0078 00120 (test.go:7)	MOVQ	AX, &quot;&quot;.bs+128(SP)
</code></pre>
<p>ä»¥ä¸‹ä¸ºç°è±¡äºŒè½¬æ¢çš„æ±‡ç¼–ä»£ç å…³é”®éƒ¨åˆ†</p>
<pre><code>&quot;&quot;.main STEXT size=393 args=0x0 locals=0xe0
	0x0000 00000 (test.go:5)	TEXT	&quot;&quot;.main(SB), ABIInternal, $224-0
	0x0000 00000 (test.go:5)	MOVQ	(TLS), CX
	0x0009 00009 (test.go:5)	LEAQ	-96(SP), AX
	0x000e 00014 (test.go:5)	CMPQ	AX, 16(CX)
	0x0012 00018 (test.go:5)	JLS	383
	0x0018 00024 (test.go:5)	SUBQ	$224, SP
	0x001f 00031 (test.go:5)	MOVQ	BP, 216(SP)
	0x0027 00039 (test.go:5)	LEAQ	216(SP), BP
	0x002f 00047 (test.go:5)	FUNCDATA	$0, gclocalsÂ·0ce64bbc7cfa5ef04d41c861de81a3d7(SB)
	0x002f 00047 (test.go:5)	FUNCDATA	$1, gclocalsÂ·00590b99cfcd6d71bbbc6e05cb4f8bf8(SB)
	0x002f 00047 (test.go:5)	FUNCDATA	$2, gclocalsÂ·8dcadbff7c52509cfe2d26e4d7d24689(SB)
	0x002f 00047 (test.go:5)	FUNCDATA	$3, &quot;&quot;.main.stkobj(SB)
	0x002f 00047 (test.go:6)	PCDATA	$0, $1
	0x002f 00047 (test.go:6)	PCDATA	$1, $0
	0x002f 00047 (test.go:6)	LEAQ	go.string.&quot;abc&quot;(SB), AX
	0x0036 00054 (test.go:6)	MOVQ	AX, &quot;&quot;.a+120(SP)
	0x003b 00059 (test.go:6)	MOVQ	$3, &quot;&quot;.a+128(SP)
	0x0047 00071 (test.go:7)	PCDATA	$0, $2
	0x0047 00071 (test.go:7)	LEAQ	&quot;&quot;..autotmp_5+64(SP), CX
	0x004c 00076 (test.go:7)	PCDATA	$0, $1
	0x004c 00076 (test.go:7)	MOVQ	CX, (SP)
	0x0050 00080 (test.go:7)	PCDATA	$0, $0
	0x0050 00080 (test.go:7)	MOVQ	AX, 8(SP)
	0x0055 00085 (test.go:7)	MOVQ	$3, 16(SP)
	0x005e 00094 (test.go:7)	CALL	runtime.stringtoslicebyte(SB)
	0x0063 00099 (test.go:7)	MOVQ	40(SP), AX
	0x0068 00104 (test.go:7)	MOVQ	32(SP), CX
	0x006d 00109 (test.go:7)	PCDATA	$0, $3
	0x006d 00109 (test.go:7)	MOVQ	24(SP), DX
	0x0072 00114 (test.go:7)	PCDATA	$0, $0
	0x0072 00114 (test.go:7)	PCDATA	$1, $1
	0x0072 00114 (test.go:7)	MOVQ	DX, &quot;&quot;.bs+136(SP)
	0x007a 00122 (test.go:7)	MOVQ	CX, &quot;&quot;.bs+144(SP)
	0x0082 00130 (test.go:7)	MOVQ	AX, &quot;&quot;.bs+152(SP)
</code></pre>
<p>åœ¨çœ‹æ±‡ç¼–ä»£ç ä¹‹å‰ï¼Œ æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€çœ‹<code>runtime.stringtoslicebyte</code>çš„å‡½æ•°ç­¾å</p>
<pre><code>func stringtoslicebyte(buf *tmpBuf, s string) []byte
</code></pre>
<p>åˆ°è¿™é‡Œåªé å…³é”®è¯å·²ç»æ— æ³•çœ‹å‡ºæ›´å¤šçš„ä¿¡æ¯äº†,è¿˜æ˜¯éœ€è¦ç¨å¾®äº†è§£ä¸€ä¸‹æ±‡ç¼–çš„è¯­æ³•,ç¬”è€…åœ¨è¿™é‡Œåˆ—å‡ºä¸€ç‚¹ç®€å•çš„åˆ†æï¼Œ ä¹‹åæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥é€šè¿‡å–å·§çš„æ–¹æ³•å‘ç°æ›´å¤šçš„ä¸œè¥¿</p>
<pre><code>// ç°è±¡ä¸€ç»™runtime.stringtoslicebyteçš„ä¼ å‚
0x002f 00047 (test.go:6)	LEAQ	go.string.&quot;abc&quot;(SB), AX // å°†å­—ç¬¦ä¸²&quot;abc&quot;æ”¾å…¥å¯„å­˜å™¨AX
0x0036 00054 (test.go:6)	MOVQ	AX, &quot;&quot;.a+96(SP) // å°†AXä¸­çš„å†…å®¹å­˜å…¥å˜é‡aä¸­
0x003b 00059 (test.go:6)	MOVQ	$3, &quot;&quot;.a+104(SP) // å°†å­—ç¬¦ä¸²é•¿åº¦3å­˜å…¥å˜é‡aä¸­
0x0044 00068 (test.go:7)	MOVQ	$0, (SP) // å°†0 ä¼ é€’ä¸ªruntime.stringtoslicebyte(SB)çš„ç¬¬ä¸€ä¸ªå‚æ•°(ç¬”è€…çŒœæµ‹å¯¹åº”goä¸­çš„nil)
0x004c 00076 (test.go:7)	PCDATA	$0, $0 // æ®è¯´å’Œgcæœ‰å…³ï¼Œ å…·ä½“è¿˜ä¸æ¸…æ¥šï¼Œ ä¸€èˆ¬æƒ…å†µå¯ä»¥å¿½ç•¥
0x004c 00076 (test.go:7)	MOVQ	AX, 8(SP) // å°†AXä¸­çš„å†…å®¹ä¼ é€’ç»™runtime.stringtoslicebyte(SB)çš„ç¬¬äºŒä¸ªå‚æ•°
0x0051 00081 (test.go:7)	MOVQ	$3, 16(SP) // å°†å­—ç¬¦ä¸²é•¿åº¦ä¼ é€’ç»™runtime.stringtoslicebyte(SB)çš„ç¬¬äºŒä¸ªå‚æ•°
0x005a 00090 (test.go:7)	CALL	runtime.stringtoslicebyte(SB) // è°ƒç”¨å‡½æ•°ï¼Œ æ­¤è¡Œåé¢çš„å‡ è¡Œä»£ç æ˜¯å°†è¿”å›å€¼èµ‹å€¼ç»™å˜é‡bs

// ç°è±¡äºŒç»™runtime.stringtoslicebyteçš„ä¼ å‚
0x002f 00047 (test.go:6)	LEAQ	go.string.&quot;abc&quot;(SB), AX // å°†å­—ç¬¦ä¸²&quot;abc&quot;æ”¾å…¥å¯„å­˜å™¨AX
0x0036 00054 (test.go:6)	MOVQ	AX, &quot;&quot;.a+120(SP) // å°†AXä¸­çš„å†…å®¹å­˜å…¥å˜é‡aä¸­
0x003b 00059 (test.go:6)	MOVQ	$3, &quot;&quot;.a+128(SP) // å°†å­—ç¬¦ä¸²é•¿åº¦3å­˜å…¥å˜é‡aä¸­
0x0047 00071 (test.go:7)	PCDATA	$0, $2
0x0047 00071 (test.go:7)	LEAQ	&quot;&quot;..autotmp_5+64(SP), CX // å°†å†…éƒ¨å˜é‡autotmp_5æ”¾å…¥å¯„å­˜å™¨CX
0x004c 00076 (test.go:7)	PCDATA	$0, $1
0x004c 00076 (test.go:7)	MOVQ	CX, (SP) // å°†CXä¸­çš„å†…å®¹ä¼ é€’ç»™runtime.stringtoslicebyte(SB)çš„ç¬¬ä¸€ä¸ªå‚æ•°
0x0050 00080 (test.go:7)	PCDATA	$0, $0
0x0050 00080 (test.go:7)	MOVQ	AX, 8(SP) // å°†AXä¸­çš„å†…å®¹ä¼ é€’ç»™runtime.stringtoslicebyte(SB)çš„ç¬¬äºŒä¸ªå‚æ•°
0x0055 00085 (test.go:7)	MOVQ	$3, 16(SP) // å°†å­—ç¬¦ä¸²é•¿åº¦ä¼ é€’ç»™runtime.stringtoslicebyte(SB)çš„ç¬¬äºŒä¸ªå‚æ•°
0x005e 00094 (test.go:7)	CALL	runtime.stringtoslicebyte(SB)
</code></pre>
<p>é€šè¿‡ä¸Šé¢æ±‡ç¼–ä»£ç çš„åˆ†æå¯ä»¥çŸ¥é“ï¼Œç°è±¡ä¸€å’Œç°è±¡äºŒçš„åŒºåˆ«å°±æ˜¯ä¼ é€’ç»™<code>runtime.stringtoslicebyte</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸åŒã€‚é€šè¿‡å¯¹runtimeåŒ…ä¸­<code>stringtoslicebyte</code>å‡½æ•°åˆ†æï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦æœ‰å€¼å’Œå­—ç¬¦ä¸²é•¿åº¦ä¼šå½±å“ä»£ç æ‰§è¡Œçš„åˆ†æ”¯ï¼Œä»è€Œç”Ÿæˆä¸åŒçš„åˆ‡ç‰‡ï¼Œ å› æ­¤å®¹é‡ä¸ä¸€æ ·ä¹Ÿæ˜¯å¸¸ç†ä¹‹ä¸­ï¼Œ ä¸‹é¢æˆ‘ä»¬çœ‹æºç </p>
<pre><code>func stringtoslicebyte(buf *tmpBuf, s string) []byte {
	var b []byte
	if buf != nil &amp;&amp; len(s) &lt;= len(buf) {
		*buf = tmpBuf{}
		b = buf[:len(s)]
	} else {
		b = rawbyteslice(len(s))
	}
	copy(b, s)
	return b
}
</code></pre>
<p>ç„¶è€Œï¼Œ stringtoslicebyteçš„ç¬¬ä¸€ä¸ªå‚æ•°ä»€ä¹ˆæƒ…å†µä¸‹æ‰ä¼šæœ‰å€¼ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¸ºnil, æˆ‘ä»¬ä»ç„¶ä¸æ¸…æ¥šã€‚é‚£æ€ä¹ˆåŠå‘¢ï¼Œ åªå¥½ç¥­å‡ºå…¨å±€æœç´¢å¤§æ³•ï¼š</p>
<pre><code># åœ¨goæºç æ ¹ç›®å½•æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤
grep stringtoslicebyte -r . | grep -v &quot;//&quot;
</code></pre>
<p>æœ€ç»ˆåœ¨goçš„ç¼–è¯‘å™¨æºç cmd/compile/internal/gc/walk.goå‘ç°äº†å¦‚ä¸‹ä»£ç å—</p>
<figure data-type="image" tabindex="2"><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="img" loading="lazy"></figure>
<p>æˆ‘ä»¬æŸ¥çœ‹<code>mkcall</code> å‡½æ•°ç­¾åå¯ä»¥çŸ¥é“, ä»ç¬¬å››ä¸ªå‚æ•°å¼€å§‹çš„æ‰€æœ‰å˜é‡éƒ½ä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™ç¬¬ä¸€ä¸ªå‚æ•°å¯¹åº”çš„å‡½æ•°ï¼Œ æœ€åç”Ÿæˆä¸€ä¸ª<code>*Node</code>çš„å˜é‡ã€‚å…¶ä¸­Nodeç»“æ„ä½“è§£é‡Šå¦‚ä¸‹:</p>
<pre><code>// A Node is a single node in the syntax tree.
// Actually the syntax tree is a syntax DAG, because there is only one
// node with Op=ONAME for a given instance of a variable x.
// The same is true for Op=OTYPE and Op=OLITERAL. See Node.mayBeShared.
</code></pre>
<p>ç»¼åˆä¸Šè¿°ä¿¡æ¯æˆ‘ä»¬å¾—å‡ºçš„ç»“è®ºæ˜¯ï¼Œç¼–è¯‘å™¨ä¼šå¯¹stringtoslicebyteçš„å‡½æ•°è°ƒç”¨ç”Ÿæˆä¸€ä¸ªAST(æŠ½è±¡è¯­æ³•æ ‘)å¯¹åº”çš„èŠ‚ç‚¹ã€‚å› æ­¤æˆ‘ä»¬ä¹ŸçŸ¥é“ä¼ é€’ç»™stringtoslicebyteå‡½æ•°çš„ç¬¬ä¸€ä¸ªå˜é‡ä¹Ÿå°±å¯¹åº”äºä¸Šå›¾ä¸­çš„å˜é‡a.</p>
<p>å…¶ä¸­açš„åˆå§‹å€¼ä¸º<code>nodnil()</code>çš„è¿”å›å€¼ï¼Œå³é»˜è®¤ä¸º<code>nil</code>. ä½†æ˜¯<code>n.Esc == EscNone</code>æ—¶ï¼Œaä¼šå˜æˆä¸€ä¸ªæ•°ç»„ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹EscNoneçš„è§£é‡Š.</p>
<pre><code>// æ­¤ä»£ç ä½äºcmd/compile/internal/gc/esc.goä¸­
const (
	// ...
	EscNone           // Does not escape to heap, result, or parameters.
    ...
)
</code></pre>
<p>ç”±ä¸Šå¯çŸ¥, <code>EscNone</code>ç”¨æ¥åˆ¤æ–­å˜é‡æ˜¯å¦é€ƒé€¸,åˆ°è¿™å„¿äº†æˆ‘ä»¬å°±å¾ˆå¥½åŠäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯¹ç°è±¡ä¸€å’Œç°è±¡äºŒçš„ä»£ç è¿›è¡Œé€ƒé€¸åˆ†æ.</p>
<pre><code># æ‰§è¡Œå˜é‡é€ƒé€¸åˆ†æå‘½ä»¤: go run -gcflags '-m -l' test.go
# ç°è±¡ä¸€é€ƒé€¸åˆ†æå¦‚ä¸‹ï¼š
./test.go:7:14: ([]byte)(a) escapes to heap
./test.go:8:13: main ... argument does not escape
./test.go:8:13: bs escapes to heap
./test.go:8:21: len(bs) escapes to heap
./test.go:8:30: cap(bs) escapes to heap
[97 98 99] 3 8
# ç°è±¡äºŒé€ƒé€¸åˆ†æå¦‚ä¸‹ï¼š
./test.go:7:14: main ([]byte)(a) does not escape
./test.go:8:13: main ... argument does not escape
./test.go:8:17: len(bs) escapes to heap
./test.go:8:26: cap(bs) escapes to heap
3 32
</code></pre>
<p>æ ¹æ®ä¸Šé¢çš„ä¿¡æ¯æˆ‘ä»¬çŸ¥é“åœ¨ç°è±¡ä¸€ä¸­ï¼Œbså˜é‡å‘ç”Ÿäº†é€ƒé€¸ï¼Œç°è±¡äºŒä¸­å˜é‡æœªå‘ç”Ÿé€ƒé€¸ï¼Œä¹Ÿå°±æ˜¯è¯´stringtoslicebyteå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°åœ¨å˜é‡æœªå‘ç”Ÿé€ƒé€¸æ—¶å…¶å€¼ä¸ä¸ºnil,å˜é‡å‘ç”Ÿé€ƒé€¸æ—¶å…¶å€¼ä¸ºnilã€‚åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»ææ˜ç™½stringtoslicebyteçš„ç¬¬ä¸€ä¸ªå‚æ•°äº†ï¼Œ é‚£æˆ‘ä»¬ç»§ç»­åˆ†æstringtoslicebyteçš„å†…éƒ¨é€»è¾‘</p>
<p>æˆ‘ä»¬åœ¨runtime/string.goä¸­çœ‹åˆ°stringtoslicebyteç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code>const tmpStringBufSize = 32

type tmpBuf [tmpStringBufSize]byte
</code></pre>
<p>ç»¼ä¸Š: ç°è±¡äºŒä¸­bså˜é‡æœªå‘ç”Ÿå˜é‡é€ƒé€¸, stringtoslicebyteç¬¬ä¸€ä¸ªå‚æ•°ä¸ä¸ºç©ºä¸”æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º32çš„byteæ•°ç»„, å› æ­¤åœ¨ç°è±¡äºŒä¸­ç”Ÿæˆäº†ä¸€ä¸ªå®¹é‡ä¸º32çš„åˆ‡ç‰‡</p>
<p>æ ¹æ®å¯¹stringtoslicebyteçš„æºç åˆ†æï¼Œ æˆ‘ä»¬çŸ¥é“ç°è±¡ä¸€è°ƒç”¨äº†<code>rawbyteslice</code>å‡½æ•°</p>
<pre><code>func rawbyteslice(size int) (b []byte) {
	cap := roundupsize(uintptr(size))
	p := mallocgc(cap, nil, false)
	if cap != uintptr(size) {
		memclrNoHeapPointers(add(p, uintptr(size)), cap-uintptr(size))
	}

	*(*slice)(unsafe.Pointer(&amp;b)) = slice{p, size, int(cap)}
	return
}
</code></pre>
<p>ç”±ä¸Šé¢çš„ä»£ç çŸ¥é“ï¼Œ åˆ‡ç‰‡çš„å®¹é‡é€šè¿‡runtime/msize.goä¸­çš„<code>roundupsize</code>å‡½æ•°è®¡ç®—å¾—å‡º, å…¶ä¸­_MaxSmallSizeå’Œclass_to_sizeå‡å®šä¹‰åœ¨runtime/sizeclasses.go</p>
<pre><code>func roundupsize(size uintptr) uintptr {
	if size &lt; _MaxSmallSize {
		if size &lt;= smallSizeMax-8 {
			return uintptr(class_to_size[size_to_class8[(size+smallSizeDiv-1)/smallSizeDiv]])
		} else {
			return uintptr(class_to_size[size_to_class128[(size-smallSizeMax+largeSizeDiv-1)/largeSizeDiv]])
		}
	}
	if size+_PageSize &lt; size {
		return size
	}
	return round(size, _PageSize)
}
</code></pre>
<p>ç”±äºå­—ç¬¦ä¸²abcçš„é•¿åº¦å°äº_MaxSmallSize(32768)ï¼Œæ•…åˆ‡ç‰‡çš„é•¿åº¦åªèƒ½å–æ•°ç»„class_to_sizeä¸­çš„å€¼ï¼Œ å³<code>0, 8, 16, 32, 48, 64, 80, 96, 112, 128....</code>s</p>
<p>è‡³æ­¤, ç°è±¡ä¸€ä¸­åˆ‡ç‰‡å®¹é‡ä¸ºä»€ä¹ˆä¸º8ä¹ŸçœŸç›¸å¤§ç™½äº†ã€‚ç›¸ä¿¡åˆ°è¿™é‡Œå¾ˆå¤šäººå·²ç»æ˜ç™½ç°è±¡å››å’Œç°è±¡äº”æ˜¯æ€ä¹ˆå›äº‹å„¿äº†, å…¶é€»è¾‘åˆ†åˆ«ä¸ç°è±¡ä¸€å’Œç°è±¡äºŒæ˜¯ä¸€è‡´çš„ï¼Œ æœ‰å…´è¶£çš„ï¼Œ å¯ä»¥åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šé¢è¯•ä¸€è¯•ã€‚</p>
<h3 id="å­—ç¬¦ä¸²ç›´æ¥è½¬åˆ‡ç‰‡">å­—ç¬¦ä¸²ç›´æ¥è½¬åˆ‡ç‰‡</h3>
<p>é‚£ä½ è¯´äº†è¿™ä¹ˆå¤šï¼Œ ç°è±¡ä¸‰è¿˜æ˜¯ä¸èƒ½è§£é‡Šå•Šã€‚è¯·å„ä½çœ‹å®˜è«æ€¥ï¼Œ æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­åˆ†æã€‚</p>
<p>ç›¸ä¿¡å„ä½ç»†å¿ƒçš„å°ä¼™ä¼´åº”è¯¥æ—©å°±å‘ç°äº†æˆ‘ä»¬åœ¨ä¸Šé¢çš„<code>cmd/compile/internal/gc/walk.go</code>æºç å›¾ä¸­æŠ˜å äº†éƒ¨åˆ†ä»£ç ï¼Œ ç°åœ¨æˆ‘ä»¬å°±å°†è¿™å—ç¥ç§˜çš„ä»£ç èµ¤è£¸è£¸çš„å±•ç¤ºå‡ºæ¥</p>
<p>æˆ‘ä»¬åˆ†æè¿™å—ä»£ç å‘ç°,goç¼–è¯‘å™¨åœ¨å°†<code>å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡</code>ç”ŸæˆASTæ—¶ï¼Œæ€»å…±åˆ†ä¸ºä¸‰æ­¥ã€‚</p>
<ol>
<li>å…ˆåˆ¤æ–­è¯¥å˜é‡æ˜¯å¦æ˜¯å¸¸é‡å­—ç¬¦ä¸²,å¦‚æœæ˜¯å¸¸é‡å­—ç¬¦ä¸²,åˆ™ç›´æ¥é€šè¿‡<code>types.NewArray</code>åˆ›å»ºä¸€ä¸ªå’Œå­—ç¬¦ä¸²ç­‰é•¿çš„æ•°ç»„</li>
<li>å¸¸é‡å­—ç¬¦ä¸²ç”Ÿæˆçš„åˆ‡ç‰‡å˜é‡ä¹Ÿè¦è¿›è¡Œé€ƒé€¸åˆ†æï¼Œå¹¶åˆ¤æ–­å…¶å¤§å°æ˜¯å¦å¤§äºå‡½æ•°æ ˆå…è®¸åˆ†é…ç»™å˜é‡çš„æœ€å¤§é•¿åº¦ï¼Œ ä»è€Œåˆ¤æ–­èŠ‚ç‚¹æ˜¯åˆ†é…åœ¨æ ˆä¸Šè¿˜æ˜¯åœ¨å †ä¸Š</li>
<li>æœ€åï¼Œå¦‚æœå­—ç¬¦ä¸²é•¿åº¦æ˜¯å¤§äº0ï¼Œ å°†å­—ç¬¦ä¸²å†…å®¹å¤åˆ¶åˆ°å­—èŠ‚åˆ‡ç‰‡ä¸­ï¼Œ ç„¶åè¿”å›ã€‚å› æ­¤ç°è±¡ä¸‰ä¸­çš„åˆ‡ç‰‡å®¹é‡æ˜¯3ä¹Ÿå°±å®Œå…¨æ¸…æ¥šäº†</li>
</ol>
<h2 id="ç»“è®º">ç»“è®º</h2>
<p>å­—ç¬¦ä¸²è½¬å­—èŠ‚åˆ‡ç‰‡æ­¥éª¤å¦‚ä¸‹</p>
<ol>
<li>
<p>åˆ¤æ–­æ˜¯å¦æ˜¯å¸¸é‡ï¼Œ å¦‚æœæ˜¯å¸¸é‡åˆ™è½¬æ¢ä¸ºç­‰å®¹é‡ç­‰é•¿çš„å­—èŠ‚åˆ‡ç‰‡</p>
</li>
<li>
<p>å¦‚æœæ˜¯å˜é‡ï¼Œ å…ˆåˆ¤æ–­ç”Ÿæˆçš„åˆ‡ç‰‡æ˜¯å¦å‘ç”Ÿå˜é‡é€ƒé€¸</p>
</li>
<li>
<ul>
<li>å¦‚æœé€ƒé€¸æˆ–è€…å­—ç¬¦ä¸²é•¿åº¦&gt;32ï¼Œ åˆ™æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦å¯ä»¥è®¡ç®—å‡ºä¸åŒçš„å®¹é‡</li>
<li>å¦‚æœæœªé€ƒé€¸ä¸”å­—ç¬¦ä¸²é•¿åº¦&lt;=32, åˆ™å­—ç¬¦åˆ‡ç‰‡å®¹é‡ä¸º32</li>
</ul>
</li>
</ol>
<h2 id="æ‰©å±•">æ‰©å±•</h2>
<p>å¸¸è§é€ƒé€¸æƒ…å†µ</p>
<ol>
<li>å‡½æ•°è¿”å›å±€éƒ¨æŒ‡é’ˆ</li>
<li>æ ˆç©ºé—´ä¸è¶³é€ƒé€¸</li>
<li>åŠ¨æ€ç±»å‹é€ƒé€¸, å¾ˆå¤šå‡½æ•°å‚æ•°ä¸ºinterfaceç±»å‹ï¼Œæ¯”å¦‚fmt.Println(a ...interface{})ï¼Œç¼–è¯‘æœŸé—´å¾ˆéš¾ç¡®å®šå…¶å‚æ•°çš„å…·ä½“ç±»å‹, ä¹Ÿä¼šå‘ç”Ÿé€ƒé€¸</li>
<li>é—­åŒ…å¼•ç”¨å¯¹è±¡é€ƒé€¸</li>
</ol>
<blockquote>
<p>æ³¨: å†™æœ¬æ–‡æ—¶ï¼Œ ç¬”è€…æ‰€ç”¨goç‰ˆæœ¬ä¸º: go1.13.4</p>
</blockquote>
<blockquote>
<p>ç”Ÿå‘½ä¸æ¯ï¼Œ æ¢ç´¢ä¸æ­¢ï¼Œ åç»­å°†æŒç»­æ›´æ–°æœ‰å…³äºgoçš„æŠ€æœ¯æ¢ç´¢</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä½¿ç”¨ Hugo æ­å»ºåšå®¢]]></title>
        <id>https://ChicRingo.github.io/post/shi-yong-hugo-da-jian-bo-ke/</id>
        <link href="https://ChicRingo.github.io/post/shi-yong-hugo-da-jian-bo-ke/">
        </link>
        <updated>2020-08-21T15:40:21.000Z</updated>
        <content type="html"><![CDATA[<p>https://www.diguage.com/post/building-blog-with-hugo/</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä½¿ç”¨2ä¸ªgoroutineè½®æµæ‰“å°ä¸€ä¸ªæ•°ç»„]]></title>
        <id>https://ChicRingo.github.io/post/shi-yong-2-ge-goroutine-lun-liu-da-yin-yi-ge-shu-zu/</id>
        <link href="https://ChicRingo.github.io/post/shi-yong-2-ge-goroutine-lun-liu-da-yin-yi-ge-shu-zu/">
        </link>
        <updated>2020-08-21T11:11:56.000Z</updated>
        <summary type="html"><![CDATA[<p>ä»Šå¤©é‡åˆ°ç¾¤å‹çš„ä¸€åˆ°é¢è¯•é¢˜ï¼Œæ„Ÿè§‰åœ¨å„ç§åœ°æ–¹çœ‹åˆ°å¾ˆå¤šæ¬¡è¿™ç§ç±»ä¼¼çš„é¢˜ç›®ï¼Œæ¯”å¦‚ä¸¤ä¸ªgoroutineè½®æµæ‰“å°å¥‡å¶æ•°ï¼Œæ‰€ä»¥è®°å½•æ•´ç†ä¸‹æ¥ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>ä»Šå¤©é‡åˆ°ç¾¤å‹çš„ä¸€åˆ°é¢è¯•é¢˜ï¼Œæ„Ÿè§‰åœ¨å„ç§åœ°æ–¹çœ‹åˆ°å¾ˆå¤šæ¬¡è¿™ç§ç±»ä¼¼çš„é¢˜ç›®ï¼Œæ¯”å¦‚ä¸¤ä¸ªgoroutineè½®æµæ‰“å°å¥‡å¶æ•°ï¼Œæ‰€ä»¥è®°å½•æ•´ç†ä¸‹æ¥ã€‚</p>
<!-- more -->
<pre><code class="language-go">package main

import (
    &quot;fmt&quot;
    &quot;sync&quot;
)

// ä½¿ç”¨2ä¸ªgoroutineè½®æµæ‰“å°ä¸€ä¸ªæ•°ç»„
var wg sync.WaitGroup
var ch = make(chan bool)
var send = make(chan int)

func main() {
    wg.Add(3)
    nums := []int{1, 2, 3, 4, 5, 6, 7, 8, 9}
    l := len(nums)
    go Send(nums, l)      // å‘é€
    go printOdd(l)  // æ‰“å°å¥‡æ•°
    go printEven(l) // æ‰“å°å¶æ•°
    wg.Wait()
}

// å‘é€æ•°ç»„å…ƒç´ 
func Send(nums []int, l int) {
    defer wg.Done()
    for i := 0; i &lt; l; i++ {
        a := nums[i]
        send &lt;- a
    }
}

// æ‰“å°å¥‡æ•°
func printEven(l int) {
    defer wg.Done()
    for i := 0; i &lt; l; i++ {
        ch &lt;- true
        if i&amp;1 == 0 {
            a := &lt;-send
            fmt.Println(&quot;printEven:&quot;, a)
        }
    }
}

// æ‰“å°å¶æ•°
func printOdd(l int) {
    defer wg.Done()
    for i := 0; i &lt; l; i++ {
        &lt;-ch
        if i&amp;1 == 1 {
            a := &lt;-send
            fmt.Println(&quot;printOdd: &quot;, a)
        }
    }
}

</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Golang å¹¶å‘æ§åˆ¶çš„ä¸¤ç§æ¨¡å¼]]></title>
        <id>https://ChicRingo.github.io/post/golang-bing-fa-kong-zhi-de-liang-chong-mo-shi/</id>
        <link href="https://ChicRingo.github.io/post/golang-bing-fa-kong-zhi-de-liang-chong-mo-shi/">
        </link>
        <updated>2020-08-20T14:38:27.000Z</updated>
        <summary type="html"><![CDATA[<p>Golang ä¸¤ç§å¸¸ç”¨çš„å¹¶å‘æ§åˆ¶ï¼Œä½¿ç”¨ channel å’Œ WaitGroup ä¸¤ç§æ¨¡å¼</p>
]]></summary>
        <content type="html"><![CDATA[<p>Golang ä¸¤ç§å¸¸ç”¨çš„å¹¶å‘æ§åˆ¶ï¼Œä½¿ç”¨ channel å’Œ WaitGroup ä¸¤ç§æ¨¡å¼</p>
<!-- more -->
<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
	&quot;sync&quot;
	&quot;time&quot;
)

func main() {
	fmt.Println(&quot;Hello, ä¸–ç•Œ&quot;)
	handle1()
	handle2()
}

func handle1() {
	// é€šè¿‡æ— ç¼“å†²é€šé“æ¥å®ç°å¤š goroutine å¹¶å‘æ§åˆ¶

	// create channel to synchronize
	done := make(chan bool) // æ— ç¼“å†²é€šé“
	defer close(done)

	go func() {
		time.Sleep(1 * time.Second)
		fmt.Println(&quot;one done&quot;)
		done &lt;- true
	}()

	go func() {
		time.Sleep(1 * time.Second)
		fmt.Println(&quot;two done&quot;)
		done &lt;- true
	}()

	// wait until both are done
	for c := 0; c &lt; 2; c++ {
		&lt;-done
	}
	fmt.Println(&quot;handle1 done&quot;)
	// å½“ä¸» goroutine è¿è¡Œåˆ° &lt;-done æ¥å— channel çš„å€¼çš„æ—¶å€™ï¼Œå¦‚æœè¯¥  channel ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°±ä¼šä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰å€¼ã€‚
}

func handle2() {
	// é€šè¿‡syncåŒ…ä¸­çš„WaitGroup å®ç°å¹¶å‘æ§åˆ¶

	var wg sync.WaitGroup

	wg.Add(1)
	go func() {
		time.Sleep(1 * time.Second)
		fmt.Println(&quot;1 done&quot;)
		wg.Done()
	}()

	wg.Add(1)
	go func() {
		time.Sleep(1 * time.Second)
		fmt.Println(&quot;2 done&quot;)
		wg.Done()
	}()
	wg.Wait()
	fmt.Println(&quot;handle2 done&quot;)

	// åœ¨ sync åŒ…ä¸­ï¼Œæä¾›äº† WaitGroup ï¼Œå®ƒä¼šç­‰å¾…å®ƒæ”¶é›†çš„æ‰€æœ‰ goroutine ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼Œåœ¨ä¸» goroutine ä¸­ Add(delta int) ç´¢è¦ç­‰å¾…goroutine çš„æ•°é‡ã€‚åœ¨æ¯ä¸€ä¸ª goroutine å®Œæˆå Done() è¡¨ç¤ºè¿™ä¸€ä¸ªgoroutine å·²ç»å®Œæˆï¼Œå½“æ‰€æœ‰çš„ goroutine éƒ½å®Œæˆåï¼Œåœ¨ä¸» goroutine ä¸­ WaitGroup è¿”å›ã€‚
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Golangå¹¶å‘æ¨¡å‹ï¼šå¹¶å‘åç¨‹çš„ä¼˜é›…é€€å‡º]]></title>
        <id>https://ChicRingo.github.io/post/golang-bing-fa-mo-xing-bing-fa-xie-cheng-de-you-ya-tui-chu/</id>
        <link href="https://ChicRingo.github.io/post/golang-bing-fa-mo-xing-bing-fa-xie-cheng-de-you-ya-tui-chu/">
        </link>
        <updated>2020-08-20T11:35:30.000Z</updated>
        <summary type="html"><![CDATA[<p>æ–‡ç« æ¥æºï¼š<a href="https://lessisbetter.site/2018/12/02/golang-exit-goroutine-in-3-ways/">Golangå¹¶å‘æ¨¡å‹ï¼šå¹¶å‘åç¨‹çš„ä¼˜é›…é€€å‡º</a><br>
goroutineä½œä¸ºGolangå¹¶å‘çš„æ ¸å¿ƒï¼Œæˆ‘ä»¬ä¸ä»…è¦å…³æ³¨å®ƒä»¬çš„åˆ›å»ºå’Œç®¡ç†ï¼Œå½“ç„¶è¿˜è¦å…³æ³¨å¦‚ä½•åˆç†çš„é€€å‡ºè¿™äº›åç¨‹ï¼Œä¸ï¼ˆåˆç†ï¼‰é€€å‡ºä¸ç„¶å¯èƒ½ä¼šé€ æˆé˜»å¡ã€panicã€ç¨‹åºè¡Œä¸ºå¼‚å¸¸ã€æ•°æ®ç»“æœä¸æ­£ç¡®ç­‰é—®é¢˜ã€‚è¿™ç¯‡æ–‡ç« ä»‹ç»ï¼Œå¦‚ä½•åˆç†çš„é€€å‡ºgoroutineï¼Œå‡å°‘è½¯ä»¶bugã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>æ–‡ç« æ¥æºï¼š<a href="https://lessisbetter.site/2018/12/02/golang-exit-goroutine-in-3-ways/">Golangå¹¶å‘æ¨¡å‹ï¼šå¹¶å‘åç¨‹çš„ä¼˜é›…é€€å‡º</a><br>
goroutineä½œä¸ºGolangå¹¶å‘çš„æ ¸å¿ƒï¼Œæˆ‘ä»¬ä¸ä»…è¦å…³æ³¨å®ƒä»¬çš„åˆ›å»ºå’Œç®¡ç†ï¼Œå½“ç„¶è¿˜è¦å…³æ³¨å¦‚ä½•åˆç†çš„é€€å‡ºè¿™äº›åç¨‹ï¼Œä¸ï¼ˆåˆç†ï¼‰é€€å‡ºä¸ç„¶å¯èƒ½ä¼šé€ æˆé˜»å¡ã€panicã€ç¨‹åºè¡Œä¸ºå¼‚å¸¸ã€æ•°æ®ç»“æœä¸æ­£ç¡®ç­‰é—®é¢˜ã€‚è¿™ç¯‡æ–‡ç« ä»‹ç»ï¼Œå¦‚ä½•åˆç†çš„é€€å‡ºgoroutineï¼Œå‡å°‘è½¯ä»¶bugã€‚</p>
<!-- more -->
<p>goroutineåœ¨é€€å‡ºæ–¹é¢ï¼Œä¸åƒçº¿ç¨‹å’Œè¿›ç¨‹ï¼Œä¸èƒ½é€šè¿‡æŸç§æ‰‹æ®µ<strong>å¼ºåˆ¶</strong>å…³é—­å®ƒä»¬ï¼Œåªèƒ½ç­‰å¾…goroutineä¸»åŠ¨é€€å‡ºã€‚ä½†ä¹Ÿæ— éœ€ä¸ºé€€å‡ºã€å…³é—­goroutineè€Œçƒ¦æ¼ï¼Œä¸‹é¢å°±ä»‹ç»3ç§ä¼˜é›…é€€å‡ºgoroutineçš„æ–¹æ³•ï¼Œåªè¦é‡‡ç”¨è¿™ç§æœ€ä½³å®è·µå»è®¾è®¡ï¼ŒåŸºæœ¬ä¸Šå°±å¯ä»¥ç¡®ä¿goroutineé€€å‡ºä¸Šä¸ä¼šæœ‰é—®é¢˜ï¼Œå°½æƒ…äº«ç”¨ã€‚</p>
<h3 id="1ä½¿ç”¨for-rangeé€€å‡º">1ï¼šä½¿ç”¨for-rangeé€€å‡º</h3>
<p><code>for-range</code>æ˜¯ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„ç»“æ„ï¼Œå¸¸ç”¨å®ƒæ¥éå†æ•°æ®ï¼Œ<strong><code>range</code>èƒ½å¤Ÿæ„ŸçŸ¥channelçš„å…³é—­ï¼Œå½“channelè¢«å‘é€æ•°æ®çš„åç¨‹å…³é—­æ—¶ï¼Œrangeå°±ä¼šç»“æŸ</strong>ï¼Œæ¥ç€é€€å‡ºforå¾ªç¯ã€‚</p>
<p>å®ƒåœ¨å¹¶å‘ä¸­çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼šå½“åç¨‹åªä»1ä¸ªchannelè¯»å–æ•°æ®ï¼Œç„¶åè¿›è¡Œå¤„ç†ï¼Œå¤„ç†ååç¨‹é€€å‡ºã€‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ç¨‹åºï¼Œå½“iné€šé“è¢«å…³é—­æ—¶ï¼Œåç¨‹å¯è‡ªåŠ¨é€€å‡ºã€‚</p>
<pre><code>go func(in &lt;-chan int) {
    // Using for-range to exit goroutine
    // range has the ability to detect the close/end of a channel
    for x := range in {
        fmt.Printf(&quot;Process %d\n&quot;, x)
    }
}(inCh)
</code></pre>
<h3 id="2ä½¿ç”¨oké€€å‡º">2ï¼šä½¿ç”¨,oké€€å‡º</h3>
<p><code>for-select</code>ä¹Ÿæ˜¯ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„ç»“æ„ï¼Œselectæä¾›äº†å¤šè·¯å¤ç”¨çš„èƒ½åŠ›ï¼Œæ‰€ä»¥for-selectå¯ä»¥è®©å‡½æ•°å…·æœ‰æŒç»­å¤šè·¯å¤„ç†å¤šä¸ªchannelçš„èƒ½åŠ›ã€‚<strong>ä½†selectæ²¡æœ‰æ„ŸçŸ¥channelçš„å…³é—­ï¼Œè¿™å¼•å‡ºäº†2ä¸ªé—®é¢˜</strong>ï¼š</p>
<ol>
<li>ç»§ç»­åœ¨å…³é—­çš„é€šé“ä¸Šè¯»ï¼Œä¼šè¯»åˆ°é€šé“ä¼ è¾“æ•°æ®ç±»å‹çš„é›¶å€¼ï¼Œå¦‚æœæ˜¯æŒ‡é’ˆç±»å‹ï¼Œè¯»åˆ°nilï¼Œç»§ç»­å¤„ç†è¿˜ä¼šäº§ç”Ÿnilã€‚</li>
<li>ç»§ç»­åœ¨å…³é—­çš„é€šé“ä¸Šå†™ï¼Œå°†ä¼španicã€‚</li>
</ol>
<p>é—®é¢˜2å¯ä»¥è¿™æ ·è§£å†³ï¼Œé€šé“åªç”±å‘é€æ–¹å…³é—­ï¼Œæ¥æ”¶æ–¹ä¸å¯å…³é—­ï¼Œå³æŸä¸ªå†™é€šé“åªç”±ä½¿ç”¨è¯¥selectçš„åç¨‹å…³é—­ï¼Œselectä¸­å°±ä¸å­˜åœ¨ç»§ç»­åœ¨å…³é—­çš„é€šé“ä¸Šå†™æ•°æ®çš„é—®é¢˜ã€‚</p>
<p>é—®é¢˜1å¯ä»¥ä½¿ç”¨<code>,ok</code>æ¥æ£€æµ‹é€šé“çš„å…³é—­ï¼Œä½¿ç”¨æƒ…å†µæœ‰2ç§ã€‚</p>
<p>ç¬¬ä¸€ç§ï¼š<strong>å¦‚æœæŸä¸ªé€šé“å…³é—­åï¼Œéœ€è¦é€€å‡ºåç¨‹ï¼Œç›´æ¥returnå³å¯</strong>ã€‚ç¤ºä¾‹ä»£ç ä¸­ï¼Œè¯¥åç¨‹éœ€è¦ä»iné€šé“è¯»æ•°æ®ï¼Œè¿˜éœ€è¦å®šæ—¶æ‰“å°å·²ç»å¤„ç†çš„æ•°é‡ï¼Œæœ‰2ä»¶äº‹è¦åšï¼Œæ‰€æœ‰ä¸èƒ½ä½¿ç”¨for-rangeï¼Œéœ€è¦ä½¿ç”¨for-selectï¼Œå½“inå…³é—­æ—¶ï¼Œ<code>ok=false</code>ï¼Œæˆ‘ä»¬ç›´æ¥è¿”å›ã€‚</p>
<pre><code>go func() {
	// in for-select using ok to exit goroutine
	for {
		select {
		case x, ok := &lt;-in:
			if !ok {
				return
			}
			fmt.Printf(&quot;Process %d\n&quot;, x)
			processedCnt++
		case &lt;-t.C:
			fmt.Printf(&quot;Working, processedCnt = %d\n&quot;, processedCnt)
		}
	}
}()
</code></pre>
<p>ç¬¬äºŒç§ï¼šå¦‚æœ<strong>æŸä¸ªé€šé“å…³é—­äº†ï¼Œä¸å†å¤„ç†è¯¥é€šé“ï¼Œè€Œæ˜¯ç»§ç»­å¤„ç†å…¶ä»–case</strong>ï¼Œé€€å‡ºæ˜¯ç­‰å¾…æ‰€æœ‰çš„å¯è¯»é€šé“å…³é—­ã€‚æˆ‘ä»¬éœ€è¦<strong>ä½¿ç”¨selectçš„ä¸€ä¸ªç‰¹å¾ï¼šselectä¸ä¼šåœ¨nilçš„é€šé“ä¸Šè¿›è¡Œç­‰å¾…</strong>ã€‚è¿™ç§æƒ…å†µï¼ŒæŠŠåªè¯»é€šé“è®¾ç½®ä¸ºnilå³å¯è§£å†³ã€‚</p>
<pre><code>go func() {
	// in for-select using ok to exit goroutine
	for {
		select {
		case x, ok := &lt;-in1:
			if !ok {
				in1 = nil
			}
			// Process
		case y, ok := &lt;-in2:
			if !ok {
				in2 = nil
			}
			// Process
		case &lt;-t.C:
			fmt.Printf(&quot;Working, processedCnt = %d\n&quot;, processedCnt)
		}

		// If both in channel are closed, goroutine exit
		if in1 == nil &amp;&amp; in2 == nil {
			return
		}
	}
}()
</code></pre>
<h3 id="3ä½¿ç”¨é€€å‡ºé€šé“é€€å‡º">3ï¼šä½¿ç”¨é€€å‡ºé€šé“é€€å‡º</h3>
<p><strong>ä½¿ç”¨<code>,ok</code>æ¥é€€å‡ºä½¿ç”¨for-selectåç¨‹ï¼Œè§£å†³æ˜¯å½“è¯»å…¥æ•°æ®çš„é€šé“å…³é—­æ—¶ï¼Œæ²¡æ•°æ®è¯»æ—¶ç¨‹åºçš„æ­£å¸¸ç»“æŸ</strong>ã€‚æƒ³æƒ³ä¸‹é¢è¿™2ç§åœºæ™¯ï¼Œ<code>,ok</code>è¿˜èƒ½é€‚ç”¨å—ï¼Ÿ</p>
<ol>
<li>æ¥æ”¶çš„åç¨‹è¦é€€å‡ºäº†ï¼Œå¦‚æœå®ƒç›´æ¥é€€å‡ºï¼Œä¸å‘ŠçŸ¥å‘é€åç¨‹ï¼Œå‘é€åç¨‹å°†é˜»å¡ã€‚</li>
<li>å¯åŠ¨äº†ä¸€ä¸ªå·¥ä½œåç¨‹å¤„ç†æ•°æ®ï¼Œå¦‚ä½•é€šçŸ¥å®ƒé€€å‡ºï¼Ÿ</li>
</ol>
<p><strong>ä½¿ç”¨ä¸€ä¸ªä¸“é—¨çš„é€šé“ï¼Œå‘é€é€€å‡ºçš„ä¿¡å·ï¼Œå¯ä»¥è§£å†³è¿™ç±»é—®é¢˜</strong>ã€‚ä»¥ç¬¬2ä¸ªåœºæ™¯ä¸ºä¾‹ï¼Œåç¨‹å…¥å‚åŒ…å«ä¸€ä¸ªåœæ­¢é€šé“<code>stopCh</code>ï¼Œå½“<code>stopCh</code>è¢«å…³é—­ï¼Œ<code>case &lt;-stopCh</code>ä¼šæ‰§è¡Œï¼Œç›´æ¥è¿”å›å³å¯ã€‚</p>
<p>å½“æˆ‘å¯åŠ¨äº†100ä¸ªworkeræ—¶ï¼Œåªè¦<code>main()</code>æ‰§è¡Œå…³é—­stopChï¼Œæ¯ä¸€ä¸ªworkeréƒ½ä¼šéƒ½åˆ°ä¿¡å·ï¼Œè¿›è€Œå…³é—­ã€‚å¦‚æœ<code>main()</code>å‘stopChå‘é€100ä¸ªæ•°æ®ï¼Œè¿™ç§å°±ä½æ•ˆäº†ã€‚</p>
<pre><code>func worker(stopCh &lt;-chan struct{}) {
	go func() {
		defer fmt.Println(&quot;worker exit&quot;)
		// Using stop channel explicit exit
		for {
			select {
			case &lt;-stopCh:
				fmt.Println(&quot;Recv stop signal&quot;)
				return
			case &lt;-t.C:
				fmt.Println(&quot;Working .&quot;)
			}
		}
	}()
	return
}
</code></pre>
<h3 id="æœ€ä½³å®è·µå›é¡¾">æœ€ä½³å®è·µå›é¡¾</h3>
<ol>
<li>å‘é€åç¨‹ä¸»åŠ¨å…³é—­é€šé“ï¼Œæ¥æ”¶åç¨‹ä¸å…³é—­é€šé“ã€‚æŠ€å·§ï¼šæŠŠæ¥æ”¶æ–¹çš„é€šé“å…¥å‚å£°æ˜ä¸ºåªè¯»ï¼Œå¦‚æœæ¥æ”¶åç¨‹å…³é—­åªè¯»åç¨‹ï¼Œç¼–è¯‘æ—¶å°±ä¼šæŠ¥é”™ã€‚</li>
<li>åç¨‹å¤„ç†1ä¸ªé€šé“ï¼Œå¹¶ä¸”æ˜¯è¯»æ—¶ï¼Œåç¨‹ä¼˜å…ˆä½¿ç”¨<code>for-range</code>ï¼Œå› ä¸º<code>range</code>å¯ä»¥å…³é—­é€šé“çš„å…³é—­è‡ªåŠ¨é€€å‡ºåç¨‹ã€‚</li>
<li><code>,ok</code>å¯ä»¥å¤„ç†å¤šä¸ªè¯»é€šé“å…³é—­ï¼Œéœ€è¦å…³é—­å½“å‰ä½¿ç”¨<code>for-select</code>çš„åç¨‹ã€‚</li>
<li>æ˜¾å¼å…³é—­é€šé“<code>stopCh</code>å¯ä»¥å¤„ç†ä¸»åŠ¨é€šçŸ¥åç¨‹é€€å‡ºçš„åœºæ™¯ã€‚</li>
</ol>
<h3 id="å®Œæ•´ç¤ºä¾‹ä»£ç ">å®Œæ•´ç¤ºä¾‹ä»£ç </h3>
<p>æœ¬æ–‡æ‰€æœ‰ä»£ç éƒ½åœ¨ä»“åº“ï¼Œå¯æŸ¥çœ‹å®Œæ•´ç¤ºä¾‹ä»£ç ï¼šhttps://github.com/Shitaibin/golang_goroutine_exit</p>
<h3 id="å¹¶å‘ç³»åˆ—æ–‡ç« æ¨è">å¹¶å‘ç³»åˆ—æ–‡ç« æ¨è</h3>
<ul>
<li><a href="http://lessisbetter.site/2018/11/16/golang-introduction-to-pipeline/">Golangå¹¶å‘æ¨¡å‹ï¼šè½»æ¾å…¥é—¨æµæ°´çº¿æ¨¡å‹</a></li>
<li><a href="http://lessisbetter.site/2018/11/28/golang-pipeline-fan-model/">Golangå¹¶å‘æ¨¡å‹ï¼šè½»æ¾å…¥é—¨æµæ°´çº¿FANæ¨¡å¼</a></li>
<li><a href="http://lessisbetter.site/2018/12/02/golang-exit-goroutine-in-3-ways/">Golangå¹¶å‘æ¨¡å‹ï¼šå¹¶å‘åç¨‹çš„ä¼˜é›…é€€å‡º</a></li>
</ul>
<blockquote>
<ol>
<li>å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¸å¦¨å…³æ³¨ä¸‹æˆ‘çš„Githubï¼Œæœ‰æ–‡ç« ä¼šæ”¶åˆ°é€šçŸ¥ã€‚</li>
<li>æœ¬æ–‡ä½œè€…ï¼š<a href="http://lessisbetter.site/about/">å¤§å½¬</a></li>
<li>å¦‚æœå–œæ¬¢æœ¬æ–‡ï¼Œéšæ„è½¬è½½ï¼Œä½†è¯·ä¿ç•™æ­¤åŸæ–‡é“¾æ¥ï¼šhttp://lessisbetter.site/2018/12/02/golang-exit-goroutine-in-3-ways/</li>
</ol>
</blockquote>
]]></content>
    </entry>
</feed>