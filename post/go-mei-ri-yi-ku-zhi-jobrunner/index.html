<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Go 每日一库之 jobrunner | ChicRingo个人博客</title>

<link rel="shortcut icon" href="https://ChicRingo.github.io/favicon.ico?v=1602400556049">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://ChicRingo.github.io/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            ChicRingo个人博客
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            首页
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            归档
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            标签
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            关于
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1602400556049" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    Go 每日一库之 jobrunner
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2020-09-03 ·
                    </time>
                    
                </div>
                <div class="post-content">
                    <ol>
<li>
<h2 id="简介">简介</h2>
<p>我们在 Web 开发中时常会遇到这样的需求，执行一个操作之后，需要给用户一定形式的通知。例如，用户下单之后通过邮件发送电子发票，网上购票支付后通过短信发送车次信息。但是这类需求并不需要非常及时，如果放在请求流程中处理，会影响请求的响应时间。这类任务我们一般使用异步的方式来执行。<code>jobrunner</code>就是其中一个用来执行异步任务的 Go 语言库。得益于强大的<code>cron</code>库，再搭配<code>jobrunner</code>的任务状态监控，<code>jobrunner</code>非常易于使用。</p>
</li>
</ol>
<!-- more -->
<h2 id="快速使用">快速使用</h2>
<p>本文使用 Go Modules。</p>
<p>创建目录并初始化：</p>
<pre><code>$ mkdir jobrunner &amp;&amp; cd jobrunner
$ go mod init github.com/darjun/go-daily-lib/jobrunner
</code></pre>
<p>安装<code>jobrunner</code>：</p>
<pre><code>$ go get -u github.com/bamzi/jobrunner
</code></pre>
<p>使用：</p>
<pre><code>package main

import (
  &quot;fmt&quot;
  &quot;time&quot;

  &quot;github.com/bamzi/jobrunner&quot;
)

type GreetingJob struct {
  Name string
}

func (g GreetingJob) Run() {
  fmt.Println(&quot;Hello, &quot;, g.Name)
}

func main() {
  jobrunner.Start()
  jobrunner.Schedule(&quot;@every 5s&quot;, GreetingJob{Name: &quot;dj&quot;})

  time.Sleep(10 * time.Second)
}
</code></pre>
<p>我们创建一个任务，每隔 5s 打印一条欢迎信息。任务的创建和执行与<code>cron</code>完全相同，详细使用见我前面的一篇博文。</p>
<p>注意，<code>jobrunner</code>需要先<code>Start()</code>，然后再添加任务。因为在<code>Start()</code>中创建<code>MainCron</code>对象，先添加任务会<code>panic</code>！！！</p>
<p>注意<code>main</code>函数尾的<code>time.Sleep(10 * time.Second)</code>，因为主 goroutine 结束之后整个程序就退出了，<code>jobrunner</code>中的任务就没有机会被执行了。加上<code>time.Sleep</code>是为了让大家能看到输出，实际使用中不会这样做。</p>
<h2 id="与-web-框架整合">与 web 框架整合</h2>
<p><code>jobrunner</code>能很方便地与当前常见的 Web 框架整合，如<code>Gin/Echo/Martini/Beego/Revel</code>等。下面通过一个简单的例子演示如何在 Gin 中使用<code>jobrunner</code>：用户登录时给他的邮箱发送一封邮件。</p>
<p>首先需要安装相应的库：</p>
<pre><code>$ go get -u github.com/gin-gonic/gin
$ github.com/jordan-wright/email
</code></pre>
<p>编写代码：</p>
<pre><code>package main

import (
  &quot;fmt&quot;
  &quot;net/smtp&quot;
  &quot;time&quot;

  &quot;github.com/bamzi/jobrunner&quot;
  &quot;github.com/gin-gonic/gin&quot;
  &quot;github.com/jordan-wright/email&quot;
)

type EmailJob struct {
  Name  string
  Email string
}

type User struct {
  Name  string `form:&quot;name&quot;`
  Email string `form:&quot;email&quot;`
}

func (j EmailJob) Run() {
  e := email.NewEmail()
  e.From = &quot;leedarjun@126.com&quot;
  e.To = []string{j.Email}
  e.Cc = []string{&quot;leedarjun@126.com&quot;}
  e.Subject = &quot;Welcome To Awesome-Web&quot;
  e.Text = []byte(fmt.Sprintf(`
  Hello, %s
  Welcome Back
  `, j.Name))

  err := e.Send(&quot;smtp.126.com:25&quot;, smtp.PlainAuth(&quot;&quot;, &quot;leedarjun@126.com&quot;, &quot;yyyyyy&quot;, &quot;smtp.126.com&quot;))
  if err != nil {
    fmt.Printf(&quot;failed to send email to %s, err:%v&quot;, j.Name, err)
  }
}

func login(c *gin.Context) {
  var u User
  if c.ShouldBind(&amp;u) == nil {
    c.String(200, &quot;login success&quot;)

    jobrunner.In(5*time.Second, EmailJob{Name: u.Name, Email: u.Email})
  } else {
    c.String(404, &quot;login failed&quot;)
  }
}

func main() {
  r := gin.Default()
  r.GET(&quot;/login&quot;, login)
  r.Run(&quot;:8888&quot;)
}
</code></pre>
<p>这里只是为了简单演示，我们编写了一个简陋的<code>login</code>函数处理登录，传入<code>name</code>和<code>email</code>，然后给该<code>email</code>发送邮件。<code>email</code>库的详细使用可以查看我之前的博文了解。</p>
<p>只需要在浏览器中输入<code>http://localhost:8888/login?name=dj&amp;email=935653229@qq.com</code>，我的 QQ 邮箱就能收到邮件：</p>
<figure data-type="image" tabindex="1"><img src="https://mmbiz.qpic.cn/mmbiz_png/K8wfjf2LnNWiacxBicZx9GWLrWL3QCD5EFdk46hmzrPKRUwViakiad7HsW5wC2zVngb2rn0McfhNhoEG9q3lMyjmtQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img" loading="lazy"></figure>
<h2 id="监控">监控</h2>
<p><code>jobrunner</code>内置了一个监控模块，可以很方便地通过网页或者 API 获取当前的任务状态数据：</p>
<pre><code>package main

import (
  &quot;fmt&quot;
  &quot;html/template&quot;
  &quot;os&quot;
  &quot;time&quot;

  &quot;github.com/bamzi/jobrunner&quot;
  &quot;github.com/gin-gonic/gin&quot;
)

type GreetingJob struct {
  Name string
}

func (g GreetingJob) Run() {
  fmt.Println(&quot;Hello,&quot;, g.Name)
}

type EmailJob struct {
  Email string
}

func (e EmailJob) Run() {
  fmt.Println(&quot;Send,&quot;, e.Email)
}

func main() {
  r := gin.Default()

  jobrunner.Start()
  jobrunner.Every(5*time.Second, GreetingJob{Name: &quot;dj&quot;})
  jobrunner.Every(10*time.Second, EmailJob{Email: &quot;935653229@qq.com&quot;})

  r.GET(&quot;/jobrunner/json&quot;, JobJson)
  r.GET(&quot;/jobrunner/html&quot;, JobHtml)

  r.Run(&quot;:8888&quot;)
}

func JobJson(c *gin.Context) {
  c.JSON(200, jobrunner.StatusJson())
}

func JobHtml(c *gin.Context) {
  t, err := template.ParseFiles(os.Getenv(&quot;GOPATH&quot;) + &quot;/src/github.com/bamzi/jobrunner/views/Status.html&quot;)
  if err != nil {
    c.JSON(400, &quot;error&quot;)
  }
  t.Execute(c.Writer, jobrunner.StatusPage())
}
</code></pre>
<p>运行之后，在浏览器中输入<code>http://localhost:8888/jobrunner/html</code>查看任务状态：</p>
<figure data-type="image" tabindex="2"><img src="https://mmbiz.qpic.cn/mmbiz_png/K8wfjf2LnNWiacxBicZx9GWLrWL3QCD5EF2KYuh16uQkoqLkHok2cIH6oACuXYvLThnPaInUu2gicpg7N4a7A01pg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img" loading="lazy"></figure>
<p>这里显示任务名、任务 ID、状态、上次运行时间、下次运行时间以及处理延迟。</p>
<p>我们还可以通过<code>http://localhost:8888/jobrunner/json</code>获取原始 JSON 格式的数据自己处理：</p>
<figure data-type="image" tabindex="3"><img src="https://mmbiz.qpic.cn/mmbiz_png/K8wfjf2LnNWiacxBicZx9GWLrWL3QCD5EFMdLTUsC2a5kibeIj35PZOvmuVUMOhTpBow83yTBh7jdEUeRQsAiaQCxg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img" loading="lazy"></figure>
<h2 id="总结">总结</h2>
<p>大家如果发现好玩、好用的 Go 语言库，欢迎到 Go 每日一库 GitHub 上提交 issue😄</p>
<h2 id="参考">参考</h2>
<ol>
<li>jobrunner GitHub：https://github.com/bamzi/jobrunner</li>
<li>Go 每日一库 GitHub：https://github.com/darjun/go-daily-lib</li>
</ol>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://ChicRingo.github.io/post/li-yong-go-fan-she-ji-zhi-shi-xian-pan-duan-slice-zhong-shi-fou-cun-zai-mou-ge-item/" class="post-title gt-a-link">
                    利用Go反射机制实现判断slice中是否存在某个item
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">温故而知新</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://ChicRingo.github.io/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
